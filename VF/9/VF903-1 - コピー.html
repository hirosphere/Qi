<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"/>
<title>VF903-1</title>
<script src="../../Base/Prime.js"></script>
<script src="./VF903-Common.js"></script>
<style>
*
{
	margin: 0; padding: 0;
	font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

html
{
	background: hsl( 210, 60%, 90% );
	padding: 50px;
}

body
{
	margin: 0px auto;
	width: 720px;
	padding: 40px 40px;
	border-radius: 16px;
	min-height: 90vh;
	background: #fff;
}

button { font-size: 16px; }
button { padding: 16px 24px; }

select { height: 2em; font-size: 16px; }

p { font-size: 16px; }

.INPUT
{
	padding: 1em; line-height: 3em;
	vertical-align: middle; border: 1px solid #cca;
}
.INPUT label { margin-right: 1em;  font-size: 17px; }
.INPUT input[type="range"] { vertical-align: middle; margin-right: 1ex; width: 300px; }
.INPUT input { width: 3em; margin-right: 1em; font-size: 17px; } 

</style>
</head>
<body onload="メイン.はじめよ();">
<script>

let メイン = new function()
{
	let これ = this;

	これ.はじめよ = function()
	{
		これ.アプリ画面 = new アプリ画面の型();
	};
};

let アプリ画面の型 = 型をつくります
(
	なし,
	function()
	{
		let この型 = this;

		この型.はじめる = function()
		{
			let この実体 = this;

			この実体.モデル = new アプリの型();
			この実体.シンセ =　new モハシンセの型( この実体.モデル );

			この実体.エレメント = divエレメントをつくれ( この文書.body, { クラス: "APP" } );
			let 列車 = この実体.モデル.列車;
			let 動力車 = 列車.動力車;

			{
				let ペイン = tableエレメントをつくれ( この実体.エレメント, { クラス: "" } );
				let tbody = tbodyエレメントをつくれ( ペイン );

				数値入力ペインをつくれ( tbody, "音量", この実体.シンセ.音量, 0, 100, 1 );
				数値入力ペインをつくれ( tbody, "駆動歯数", 動力車.動力側歯数, 1, 200, 1 );
				数値入力ペインをつくれ( tbody, "被動歯数", 動力車.車輪側歯数, 1, 200, 1 );
				歯車比選択をつくる( tbody, 動力車 );
				数値入力ペインをつくれ( tbody, "指令加速度", 列車.指令加速度, -20, 20, 0.1 );
				数値入力ペインをつくれ( tbody, "加速度減衰率", 列車.加速度減衰率, 0, 100, 1 );
			}

			この実体.表示1 = pエレメントをつくれ( この実体.エレメント, { 文: "." } );

			
			{
				let ペイン = divエレメントをつくれ( この実体.エレメント, {} );
				let 減速5ボタン = ボタンをつくれ( ペイン, { 文: "減5" } );
				let 減速3ボタン = ボタンをつくれ( ペイン, { 文: "減3" } );
				let 減速2ボタン = ボタンをつくれ( ペイン, { 文: "減2" } );
				let 減速1ボタン = ボタンをつくれ( ペイン, { 文: "減1" } );
				let 減速02ボタン = ボタンをつくれ( ペイン, { 文: "減0.2" } );
				let 切りボタン = ボタンをつくれ( ペイン, { 文: "切り" } );
				let 加速1ボタン = ボタンをつくれ( ペイン, { 文: "加1" } );
				let 加速2ボタン = ボタンをつくれ( ペイン, { 文: "加2" } );
				let 加速3ボタン = ボタンをつくれ( ペイン, { 文: "加3" } );

				減速5ボタン.クリックされた( function( イベント ) { 列車.指令加速度.値を設定( -5 ); } );
				減速3ボタン.クリックされた( function( イベント ) { 列車.指令加速度.値を設定( -3 ); } );
				減速2ボタン.クリックされた( function( イベント ) { 列車.指令加速度.値を設定( -2 ); } );
				減速1ボタン.クリックされた( function( イベント ) { 列車.指令加速度.値を設定( -1 ); } );
				減速02ボタン.クリックされた( function( イベント ) { 列車.指令加速度.値を設定( -0.2 ); } );
				切りボタン.クリックされた( function( イベント ) { 列車.指令加速度.値を設定( 0 ); } );
				加速1ボタン.クリックされた( function( イベント ) { 列車.指令加速度.値を設定( 1 ); } );
				加速2ボタン.クリックされた( function( イベント ) { 列車.指令加速度.値を設定( 2 ); } );
				加速3ボタン.クリックされた( function( イベント ) { 列車.指令加速度.値を設定( 3 ); } );
			}

			この実体.表示2 = pエレメントをつくれ( この実体.エレメント, { 文: "." } );

			// 発進ボタン.タッチスタートされたよ( 定型動作を抑止 );
			
			function 定型動作を抑止( イベント )
			{
				イベント.本来の動作を阻止();
				コンソール.クリアー();
				コンソール.ログ( イベント );
			}

			この実体.モデル.コマが進んだ = function()
			{
				この実体.情報表示を更新();
			}
		};

		function 歯車比選択をつくる( tbody, 動力車 )
		{
			let tr = trエレメントをつくれ( tbody );

			tdエレメントをつくれ( tr, { 文: "( 定型比 )" } );

			let td = tdエレメントをつくれ( tr );
			td.colSpan = 2;
			
			let セレクトエレメント = selectエレメントをつくれ( td );

			optionエレメントをつくれ( セレクトエレメント, { 文: "選択" } );

			for( let アイテム of 歯車比リスト )
			{
				let 文 = `${ アイテム[0] } : ${ アイテム[1] }  ( ${ アイテム[2] } )`;
				optionエレメントをつくれ( セレクトエレメント, { 文: 文 } );
			}

			セレクトエレメント.oninput = function()
			{
				if( セレクトエレメント.selectedIndex < 1 )  return;
				let アイテム = 歯車比リスト[ セレクトエレメント.selectedIndex - 1 ];
				動力車.動力側歯数.値を設定( アイテム[ 0 ] );
				動力車.車輪側歯数.値を設定( アイテム[ 1 ] );
			};
		}

		この型.情報表示を更新 = function()
		{
			let この実体 = this;
			let 列車 = この実体.モデル.列車;
			let 動力車 = 列車.動力車;
			let 周波数 = 動力車.周波数を得る();
			
			この実体.表示1.innerText =
			`時速 ${  桁を整理( 列車.速度.値, 0 )  }km / ` +
				`秒速 ${  桁を整理( 列車.速度.値 / 3.6, 0 )  }m / ` +
				`加速度 ${  桁を整理( 列車.加速度.値, -1 )  }km/h/s`
			;
			
			この実体.表示2.innerText =
				`車輪 ${  桁を整理( 周波数.車輪, -0 )  }Hz / ` +
				`減速比 ${  桁を整理( 動力車.減速比を得る(), -2 )  } / ` +
				`モーター ${  桁を整理( 周波数.動力, -0 )  }Hz / ` +
				`ブラシ ${  桁を整理( 周波数.整流子, -0 )  }Hz / ` +
				`歯車かみ合い ${  桁を整理( 周波数.かみ合い, -0 )  }Hz / `
			;

			この実体.シンセ.更新せよ();
		}
	}
);

function 数値入力ペインをつくれ( tbody, ラベル, 値, 最小値, 最大値, きざみ )
{
	let この実体 = this;

	let tr = trエレメントをつくれ( tbody, { クラス: "INPUT" } );
	tdエレメントをつくれ( tr, { 文: ラベル } );

	let 数値入力 = inputエレメントをつくれ( tdエレメントをつくれ( tr ) );
	let スライダー = スライダーをつくれ( tdエレメントをつくれ( tr ) );
	スライダー.min = 最小値;
	スライダー.max = 最大値;
	スライダー.step = きざみ;

	数値入力.キーダウンされた( function( イベント ){ if( イベント.keyCode == 13 )  値.値を設定( this.value ); } );
	数値入力.フォーカス移動された( function( イベント ){ 値.値を設定( this.value ); } );

	スライダー.oninput = function() { 値.値を設定( this.value ); };

	値.変更通知処理を登録
	(
		function()
		{
			数値入力.value = 値.値;
			スライダー.value = 値.値;
		}
	);
}

// 実体 //

let アプリの型 = 型をつくります
(
	なし,
	function()
	{
		let この型 = this;

		この型.はじめる = function()
		{
			let この実体 = this;

			この実体.コマの長さ = 10;  //  ミリ秒
			この実体.列車 = new 列車の型();
			この実体.コマが進んだ = なし;

			間欠を設定( function() { この実体.コマを進める(); }, この実体.コマの長さ );
		};

		この型.コマを進める = function()
		{
			let この実体 = this;

			この実体.列車.コマを進めよ( この実体.コマの長さ );
			この実体.コマが進んだ && この実体.コマが進んだ( この実体.コマの長さ );
		};
	}
);


let 歯車比リスト =
[
	[ 13, 78, "京成3300" ],
	[ 14, 99, "207系 209系 E231系" ],
	[ 15, 84, "201系" ],
	[ 15, 91, "103系" ],
	[ 16, 83, "211系 213系 215系 221系" ],
	[ 17, 82, "113系 115系 117系 403系 415系 417系 185系 251系 253系" ],
	[ 18, 97, "小田急9000系" ],
	[ 19, 80, "165系 455系 京急2000" ],
	[ 20, 79, "651系" ],
	[ 21, 78, "" ],
	[ 22, 77, "183系 485系 583系" ],
]


let 列車の型 = 型をつくります
(
	なし,
	function()
	{
		let この型 = this;

		この型.はじめる = function()
		{
			let これ = this;

			これ.指令加速度 = new 値の型( 0 );
			これ.加速度減衰率 = new 値の型( 65 );
			これ.動力車 = new 動力車の型( これ );

			これ.加速度 = new 値の型( 0 );
			これ.速度 = new 値の型( 0 );
		};

		この型.秒速 = function()
		{
			let これ = this;

			return これ.速度.値 / 3600 * 1000;
		};

		この型.コマを進めよ = function( ミリ秒 )
		{
			let これ = this;

			if( これ.指令加速度.値 > 0 )
			{
				let 減衰率 = 1 - ( これ.速度.値 / 100 ) * ( これ.加速度減衰率.値 / 100 );
				これ.加速度.値 = これ.指令加速度.値 * 減衰率;
			}
			else
			{
				これ.加速度.値 = これ.指令加速度.値;
			}

			これ.速度.値 += これ.加速度.値 * ミリ秒 / 1000;
			if( これ.速度.値 <= 0 ) これ.速度.値 = 0;
		};
	}
);


let 動力車の型 = 型をつくります
(
	無,
	function()
	{
		let この型 = this;  //  背景典型実体  //

		この型.はじめる = function( 列車 )
		{
			let これ = this;

			これ.列車 = 列車;
			これ.動力整流子数 = new 値の型( 5 );
			これ.動力側歯数 = new 値の型( 15 );
			これ.車輪側歯数 = new 値の型( 91 );
			これ.車輪径 = new 値の型( 860 );
		};

		この型.減速比を得る = function()
		{
			let これ = this;
			return これ.車輪側歯数.値 / これ.動力側歯数.値;
		};

		この型.周波数を得る = function()
		{
			let これ = this;
			let 返り値 = {};
			let 秒速mm = これ.列車.速度.値 / 3600 * 1000 * 1000;

			返り値.車輪 = 秒速mm / これ.車輪径.値;
			返り値.かみ合い = 返り値.車輪 * これ.車輪側歯数.値;
			返り値.動力 = 返り値.かみ合い / これ.動力側歯数.値;
			返り値.整流子 = 返り値.動力 * これ.動力整流子数.値;

			return 返り値;
		};
	}
);

// 表示 //


// 発音器 //

let モハシンセの型 = 型をつくります
(
	なし,
	function()
	{
		let この型 = this;

		この型.はじめる = function( アプリ )
		{
			let これ = this;
			これ.列車 = アプリ.列車;
			これ.コマの長さms = アプリ.コマの長さ;

			これ.音量 = new 値の型( 50 );

			let 音響文脈 = new 音響文脈の型();
			let いま = 音響文脈.いまの時刻();

			/* ノード作成 */

			let オシレーター1 = 音響文脈.オシレーターを作成();
			let オシレーター2 = 音響文脈.オシレーターを作成();
			let オシレーター3 = 音響文脈.オシレーターを作成();
			let 音量ゲート1 = 音響文脈.ゲートを作成();
			let 音量ゲート2 = 音響文脈.ゲートを作成();
			let 音量ゲート3 = 音響文脈.ゲートを作成();
			let 全音量ゲート = 音響文脈.ゲートを作成();

			/* ノード接続 */

			オシレーター1.接続( 音量ゲート1 );
			オシレーター2.接続( 音量ゲート2 );
			オシレーター3.接続( 音量ゲート3 );

			音量ゲート1.接続( 全音量ゲート );
			音量ゲート2.接続( 全音量ゲート );
			音量ゲート3.接続( 全音量ゲート );

			全音量ゲート.接続( 音響文脈.出力先() );

			/* 初期値設定 */

			オシレーター1.周波数().値( 0 );
			//オシレーター2.周波数().値( 0 );
			//オシレーター3.周波数().値( 0 );

			let 倍音構成 = new 倍音構成の型( 音響文脈, 1024 );
			倍音構成.オシレーターへ設定( オシレーター1 );
			//オシレーター1.波形( "square" );
			//オシレーター2.波形( "sine" );
			//オシレーター3.波形( "sine" );

			音量ゲート1.ゲイン().値( 0.9 );
			//音量ゲート2.ゲイン().値( 0.3 );
			//音量ゲート3.ゲイン().値( 0.3 );
			全音量ゲート.ゲイン().その刻の値( 0, いま );

			オシレーター1.開始();
			//オシレーター2.開始();
			//オシレーター3.開始();

			これ.音響文脈 = 音響文脈;
			これ.全音量ゲート = 全音量ゲート;
			これ.オシレーター1 = オシレーター1;
			これ.オシレーター2 = オシレーター2;
			これ.オシレーター3 = オシレーター3;
			これ.更新せよ();
		};

		この型.更新せよ = function()
		{
			let これ = this;
			let いま = これ.音響文脈.いまの時刻();

			let 周波数 = これ.列車.動力車.周波数を得る();
			let 目標時刻 = いま + これ.コマの長さms / 1000;

			これ.オシレーター1.周波数().その刻へ直線変化( 周波数.動力, 目標時刻 );
			//これ.オシレーター2.周波数().値( 周波数.整流子 );
			//これ.オシレーター3.周波数().値( 周波数.かみ合い );
			これ.全音量ゲート.ゲイン().その刻へ直線変化( これ.音量.値 / 100, 目標時刻 );
		};
	}
);

let 倍音構成の型 = 型をつくります
(
	なし,
	function()
	{
		let この型 = this;

		この型.はじめる = function( 音響文脈, 次数 )
		{
			let この実体 = this;
			この実体.音響文脈 = 音響文脈;

			let real = [], imag = [];
			for( let n = 0; n <= 次数; n ++ )
			{
				real[ n ] = imag[ n ] = 0;
			}
			この実体.表 = [ real, imag ];

			この実体.生成( 1, 1, 2.0, 128 );
			この実体.生成( 5, 1, 2.0, 128 );
			この実体.生成( 15, 1, 2.0, 32 );
		};

		この型.オシレーターへ設定 = function( オシレーター )
		{
			let この実体 = this;
			オシレーター.倍音表を設定
			(
				この実体.音響文脈.倍音表を作成( この実体.表[0], この実体.表[1] )
			);
		};



		この型.生成 = function( 倍数, 強さ, 減衰の乗数, 次数の制限 )
		{
			let この実体 = this;
			let real = この実体.表[ 0 ];
			let imag = この実体.表[ 1 ];

			if( 次数の制限 == undefined ) 次数の制限 = この実体.表.length;

			for( let n = 1; ( n * 倍数 ) <= 次数の制限; n ++ )
			{
				real[ n * 倍数 ] += 1 / Math.pow( n, 減衰の乗数 );
				//imag[ n ] += 0;
			}
		};

		この型.生成2 = function( 次数 )
		{
			let この実体 = this;
			let 表 = この実体.生成( 24, 0 );
			表[ 0 ][ 1 ] = 1;
			表[ 0 ][ 5 ] = 1;
			表[ 0 ][ 15 ] = 1;
		};

		この型.生成3 = function( 強さ )
		{
			let この実体 = this;
			let real = [ 0 ], imag = [ 0 ];
			for( let n = 1, m = 1; n <= 次数; n ++ )
			{
				if( n == m )
				{
					real[ n ] = 強さ;
					m *= 2;
				}
				else real[ n ] = 0;
				imag[ n ] = 0;
			}
			return この実体.構成表集[ 表名 ] = [ real, imag ];
		};

		この型.和合 = function( 表番号1, 表番号2 )
		{
			let この実体 = this;
		};

		この型.重合 = function( 表番号1, 表番号2 )
		{
			let この実体 = this;
		};

		この型._ = function( 表番号 )
		{
			let この実体 = this;
		};
	}
);


//  //

//  //


</script>
</body>
</html>