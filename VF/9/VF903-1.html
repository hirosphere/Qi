<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"/>
<title>VF903-1</title>
<script src="../../Base/Prime.js"></script>
<script src="./VF903-Common.js"></script>
<style>
*
{
	margin: 0; padding: 0; color: #222;
	font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

html
{
	background: hsl( 210, 60%, 90% );
	padding: 50px;
}

body
{
	margin: 0px auto;
	width: 720px;
	padding: 40px 40px;
	border-radius: 16px;
	min-height: 90vh;
	background: #fff;
}

button { font-size: 16px; }
button { padding: 16px 24px; }

select { height: 2em; font-size: 16px; }

p { font-size: 16px; }

.INPUT
{
	padding: 1em; line-height: 3em;
	vertical-align: middle; border: 1px solid #cca;
}
.INPUT label { margin-right: 1em;  font-size: 17px; }
.INPUT input[type="range"] { vertical-align: middle; margin-right: 1ex; width: 300px; }
.INPUT input { width: 3em; margin-right: 1em; font-size: 17px; } 

.INFO{ margin-bottom: 12px; }
.INFO_CELL { font-size: 40px; line-height: 1; }
.INFO_UNIT { margin-left: 0.4ex; font-size: 19px; color: #998; }

</style>
</head>
<body onload="メイン.はじめよ();">
<script>

let メイン = new function()
{
	let これ = this;

	これ.はじめよ = function()
	{
		これ.アプリ画面 = new アプリ画面の型();
	};
};

let アプリ画面の型 = 型をつくります
(
	なし,
	function()
	{
		let この型 = this;

		この型.はじめる = function()
		{
			let この実体 = this;

			この実体.モデル = new アプリの型();
			この実体.シンセ =　new モハシンセの型( この実体.モデル );

			この実体.エレメント = divエレメントをつくれ( この文書.body, { クラス: "APP" } );
			let 列車 = この実体.モデル.列車;
			let 動力車 = 列車.動力車;


			{
				let テーブル = new 数値表示テーブルの型( この実体.エレメント );
				let 行 = テーブル.行を作成();
				この実体.表示 =
				{
					時速: 行.項目を作成( "時速", "km/h", 6 ),
					秒速: 行.項目を作成( "秒速", "m/s", 6 ),
					加速度: 行.項目を作成( "加速度", "km/h/s", 8 ),
					走行距離: 行.項目を作成( "走行距離", "m", 6, function(){ 列車.走行距離.値 = 0; } ),
				};

				この実体.表示1 = pエレメントをつくれ( この実体.エレメント, { クラス: "INFO_1" } );
				速度指令ボタンをつくる( この実体.エレメント, 列車 );
				この実体.表示2 = pエレメントをつくれ( この実体.エレメント, { クラス: "INFO_1" } );
			}
			{
				let ペイン = tableエレメントをつくれ( この実体.エレメント, { クラス: "" } );
				let tbody = tbodyエレメントをつくれ( ペイン );

				数値入力ペインをつくれ( tbody, "音量", この実体.シンセ.音量, 0, 100, 1 );
				数値入力ペインをつくれ( tbody, "駆動歯数", 動力車.動力側歯数, 1, 200, 1 );
				数値入力ペインをつくれ( tbody, "被動歯数", 動力車.車輪側歯数, 1, 200, 1 );
				歯車比選択をつくる( tbody, 動力車 );
				数値入力ペインをつくれ( tbody, "指令加速度", 列車.指令加速度, -20, 20, 0.1 );
				数値入力ペインをつくれ( tbody, "加速度減衰率", 列車.加速度減衰率, 0, 100, 1 );
				数値入力ペインをつくれ( tbody, "惰行減速度", 列車.惰行減速度, -2, 0, 0.01 );
			}
			
			function 定型動作を抑止( イベント )
			{
				イベント.本来の動作を阻止();
				コンソール.クリアー();
				コンソール.ログ( イベント );
			}

			この実体.モデル.コマが進んだ = function()
			{
				この実体.情報表示を更新();
			}
		};

		この型.情報表示を更新 = function()
		{
			let この実体 = this;
			let 列車 = この実体.モデル.列車;
			let 動力車 = 列車.動力車;
			let 周波数 = 動力車.周波数を得る();
			
			この実体.表示.時速.文( `${  桁を整理( 列車.速度.値, -0 )  }` );
			この実体.表示.秒速.文( `${  桁を整理( 列車.速度.値 / 3.6, -0 )  }` );
			この実体.表示.加速度.文( `${  桁を整理( 列車.加速度.値, -1 )  }` );
			この実体.表示.走行距離.文( `${  桁を整理( 列車.走行距離.値, -0 )  }` );
			
			この実体.表示2.innerText =
				`車輪 ${  桁を整理( 周波数.車輪, -0 )  }Hz / ` +
				`減速比 ${  桁を整理( 動力車.減速比を得る(), -2 )  } / ` +
				`モーター ${  桁を整理( 周波数.動力, -0 )  }Hz / ` +
				`ブラシ ${  桁を整理( 周波数.整流子, -0 )  }Hz / ` +
				`歯車かみ合い ${  桁を整理( 周波数.かみ合い, -0 )  }Hz / `
			;

			この実体.シンセ.更新せよ();
		}

		function 歯車比選択をつくる( tbody, 動力車 )
		{
			let tr = trエレメントをつくれ( tbody );

			tdエレメントをつくれ( tr, { 文: "( 定型比 )" } );

			let td = tdエレメントをつくれ( tr );
			td.colSpan = 2;
			
			let セレクトエレメント = selectエレメントをつくれ( td );

			optionエレメントをつくれ( セレクトエレメント, { 文: "選択" } );

			for( let アイテム of 歯車比リスト )
			{
				let 文 = `${ アイテム[0] } : ${ アイテム[1] }  ( ${ アイテム[2] } )`;
				optionエレメントをつくれ( セレクトエレメント, { 文: 文 } );
			}

			セレクトエレメント.oninput = function()
			{
				if( セレクトエレメント.selectedIndex < 1 )  return;
				let アイテム = 歯車比リスト[ セレクトエレメント.selectedIndex - 1 ];
				動力車.動力側歯数.値を設定( アイテム[ 0 ] );
				動力車.車輪側歯数.値を設定( アイテム[ 1 ] );
			};
		}

		function 数値表示テーブルの型( 幹 )
		{
			let table = tableエレメントをつくれ( 幹, { クラス: "INFO" } );
			let tbody = tbodyエレメントをつくれ( table );

			this.行を作成 = function() { return new 行の型(); };

			function 行の型()
			{
				let tr1 = trエレメントをつくれ( tbody );
				let tr2 = trエレメントをつくれ( tbody );

				this.項目を作成 = function( ラベル, 単位, 文字数, クリック処理 )
				{
					return new 項目の型( tr1, tr2, ラベル, 単位, 文字数, クリック処理 );
				};
			}

			function 項目の型( tr1, tr2, ラベル, 単位, 文字数, クリック処理 )
			{
				let td1 = tdエレメントをつくれ( tr1, { 文: ラベル } );
				let td2 = tdエレメントをつくれ( tr2, { クラス: "INFO_CELL" } );
				let 数値 = spanエレメントをつくれ( td2, { クラス: "INFO_VAL" } );
				spanエレメントをつくれ( td2, { 文: 単位, クラス: "INFO_UNIT" } );

				td2.style.minWidth = 文字数 + "ex";
				if( クリック処理 )  td2.クリックされた( クリック処理 );

				this.文 = function( 文 )
				{
					数値.innerHTML = 便利.文をHTMLに変換します( 文 );
				};
			}
		}

		function 速度指令ボタンをつくる( 幹, 列車 )
		{
			let リスト =
			[
				[ "-5", -5 ], [ "-3", -3 ], [ "-2", -2 ], [ "-1", -1 ],
				[ "0", 0 ], [ "1", 1 ], [ "2", 2 ], [ "3", 3 ], [ "4", 4 ]
			];
			let ペイン = divエレメントをつくれ( 幹, {} );
			
			for( let 項目 of リスト )
			{
				let ボタン = ボタンをつくれ( ペイン, { 文: 項目[ 0 ] } );
				ボタン.クリックされた( function( イベント ) { 列車.指令加速度.値を設定( 項目[ 1 ] ); } );
			}
		};
	}
);

function 数値入力ペインをつくれ( tbody, ラベル, 値, 最小値, 最大値, きざみ )
{
	let この実体 = this;

	let tr = trエレメントをつくれ( tbody, { クラス: "INPUT" } );
	tdエレメントをつくれ( tr, { 文: ラベル } );

	let 数値入力 = inputエレメントをつくれ( tdエレメントをつくれ( tr ) );
	let スライダー = スライダーをつくれ( tdエレメントをつくれ( tr ) );
	スライダー.min = 最小値;
	スライダー.max = 最大値;
	スライダー.step = きざみ;

	数値入力.キーダウンされた( function( イベント ){ if( イベント.keyCode == 13 )  値.値を設定( this.value ); } );
	数値入力.フォーカス移動された( function( イベント ){ 値.値を設定( this.value ); } );

	スライダー.oninput = function() { 値.値を設定( this.value ); };

	値.変更通知処理を登録
	(
		function()
		{
			数値入力.value = 値.値;
			スライダー.value = 値.値;
		}
	);
}

// 実体 //

let アプリの型 = 型をつくります
(
	なし,
	function()
	{
		let この型 = this;

		この型.はじめる = function()
		{
			let この実体 = this;

			この実体.コマの長さ = 100;  //  ミリ秒
			この実体.列車 = new 列車の型();
			この実体.コマが進んだ = なし;

			間欠を設定( function() { この実体.コマを進める(); }, この実体.コマの長さ );
		};

		この型.コマを進める = function()
		{
			let この実体 = this;

			この実体.列車.コマを進めよ( この実体.コマの長さ );
			この実体.コマが進んだ && この実体.コマが進んだ( この実体.コマの長さ );
		};
	}
);


let 歯車比リスト =
[
	[ 13, 78, "京成3300" ],
	[ 14, 99, "207系 209系 E231系" ],
	[ 15, 84, "201系" ],
	[ 15, 91, "103系" ],
	[ 16, 83, "211系 213系 215系 221系" ],
	[ 17, 82, "113系 115系 117系 403系 415系 417系 185系 251系 253系" ],
	[ 18, 97, "小田急9000系" ],
	[ 19, 80, "165系 455系 京急2000" ],
	[ 20, 79, "651系" ],
	[ 21, 78, "" ],
	[ 22, 77, "183系 485系 583系" ],
]


let 列車の型 = 型をつくります
(
	なし,
	function()
	{
		let この型 = this;

		この型.はじめる = function()
		{
			let これ = this;

			これ.指令加速度 = new 値の型( 0 );
			これ.加速度減衰率 = new 値の型( 65 );
			これ.惰行減速度 = new 値の型( -0.12 );

			これ.加速度 = new 値の型( 0 );
			これ.速度 = new 値の型( 0 );
			これ.走行距離 = new 値の型( 0 );

			これ.動力車 = new 動力車の型( これ );
		};

		この型.秒速 = function()
		{
			let これ = this;

			return これ.速度.値 / 3600 * 1000;
		};

		この型.コマを進めよ = function( すすみミリ秒 )
		{
			let これ = this;
			let すすみ秒 = すすみミリ秒 / 1000;

			if( これ.指令加速度.値 > 0 )
			{
				let 減衰率 = 1 - ( これ.速度.値 / 100 ) * ( これ.加速度減衰率.値 / 100 );
				これ.加速度.値 = これ.指令加速度.値 * 減衰率;
			}
			else
			{
				これ.加速度.値 = これ.指令加速度.値 + これ.惰行減速度.値;
			}

			これ.速度.値 += これ.加速度.値 * すすみ秒;
			if( これ.速度.値 <= 0 ) これ.速度.値 = 0;

			これ.走行距離.値 += これ.速度.値 / 3.6 * すすみ秒;
		};
	}
);


let 動力車の型 = 型をつくります
(
	無,
	function()
	{
		let この型 = this;  //  背景典型実体  //

		この型.はじめる = function( 列車 )
		{
			let これ = this;

			これ.列車 = 列車;
			これ.動力整流子数 = new 値の型( 5 );
			これ.動力側歯数 = new 値の型( 15 );
			これ.車輪側歯数 = new 値の型( 84 );
			これ.車輪径 = new 値の型( 860 );
		};

		この型.減速比を得る = function()
		{
			let これ = this;
			return これ.車輪側歯数.値 / これ.動力側歯数.値;
		};

		この型.周波数を得る = function()
		{
			let これ = this;
			let 返り値 = {};
			let 秒速mm = これ.列車.速度.値 / 3600 * 1000 * 1000;
			let 車輪周mm = ( これ.車輪径.値 * Math.PI );

			返り値.車輪 = 秒速mm / 車輪周mm;
			返り値.かみ合い = 返り値.車輪 * これ.車輪側歯数.値;
			返り値.動力 = 返り値.かみ合い / これ.動力側歯数.値;
			返り値.整流子 = 返り値.動力 * これ.動力整流子数.値;

			return 返り値;
		};
	}
);

// 表示 //


// 発音器 //

let モハシンセの型 = 型をつくります
(
	なし,
	function()
	{
		let この型 = this;

		この型.はじめる = function( アプリ )
		{
			let これ = this;
			これ.列車 = アプリ.列車;
			これ.コマの長さms = アプリ.コマの長さ;

			これ.音量 = new 値の型( 70 );

			let 音響文脈 = new 音響文脈の型();
			let いま = 音響文脈.いまの時刻();

			/* ノード作成 */

			let オシレーター1 = 音響文脈.オシレーターを作成();
			let 音量ゲート1 = 音響文脈.ゲートを作成();
			let 全音量ゲート = 音響文脈.ゲートを作成();

			/* ノード接続 */

			オシレーター1.接続( 音量ゲート1 );

			音量ゲート1.接続( 全音量ゲート );

			全音量ゲート.接続( 音響文脈.出力先() );

			/* 初期値設定 */

			オシレーター1.周波数().値( 0 );

			音量ゲート1.ゲイン().値( 0.9 );
			全音量ゲート.ゲイン().その刻の値( 0, いま );

			オシレーター1.開始();

			これ.音響文脈 = 音響文脈;
			これ.全音量ゲート = 全音量ゲート;
			これ.オシレーター1 = オシレーター1;

			//これ.列車.動力車.動力側歯数.値が変わった( function() { これ.倍音構成を更新せよ(); } );
			これ.更新せよ();
		};

		この型.倍音構成を更新せよ = function()
		{
			let これ = this;
			let 倍音構成 = new 倍音構成の型( これ.音響文脈, 1024 );
			倍音構成.モーター音生成( これ.列車 );
			倍音構成.オシレーターへ設定( これ.オシレーター1 );
		};

		この型.更新せよ = function()
		{
			let これ = this;
			let いま = これ.音響文脈.いまの時刻();

			let 周波数 = これ.列車.動力車.周波数を得る();
			let 目標時刻 = いま + これ.コマの長さms / 1000;

			これ.倍音構成を更新せよ();
			これ.オシレーター1.周波数().その刻へ直線変化( 周波数.動力, 目標時刻 );
			//これ.オシレーター2.周波数().値( 周波数.整流子 );
			//これ.オシレーター3.周波数().値( 周波数.かみ合い );
			これ.全音量ゲート.ゲイン().その刻へ直線変化( これ.音量.値 / 100, 目標時刻 );
		};
	}
);

let 倍音構成の型 = 型をつくります
(
	なし,
	function()
	{
		let この型 = this;

		この型.はじめる = function( 音響文脈, 次数 )
		{
			let この実体 = this;
			この実体.音響文脈 = 音響文脈;

			let real = [], imag = [];
			for( let n = 0; n <= 次数; n ++ )
			{
				real[ n ] = imag[ n ] = 0;
			}
			この実体.表 = [ real, imag ];
		};

		この型.オシレーターへ設定 = function( オシレーター )
		{
			let この実体 = this;
			オシレーター.倍音表を設定
			(
				この実体.音響文脈.倍音表を作成( この実体.表[0], この実体.表[1], { disableNormalization: true } )
			);
		};

		この型.モーター音生成 = function( 列車 )
		{
			let この実体 = this;
			let 動力車 = 列車.動力車;
			let 歯車 = 動力車.動力側歯数.値;
			let 歯車音量 = Math.min( Math.abs( 列車.加速度.値 - 列車.惰行減速度.値 ) * 1, 1 );

			let モーター音量 = 0.3;
			let ファン音量 = 0.4;
			let ブラシ音量 = 0.0;
			let 噛み音量 = 0.3 * 歯車音量;

			この実体.生成( 1, モーター音量 * 0.3, 2.5, 16 );
			この実体.生成( 2, モーター音量 * 0.3, 3.5, 16 );
			この実体.生成( 4, モーター音量 * 0.3, 4.5, 16 );
			この実体.生成( 12, ファン音量 * 1, 3.5, 16 );
			この実体.生成( 5, ブラシ音量 * 1, 4.0, 32 );
			この実体.生成( 38, モーター音量 * 0.0, 4.0, 2 );
			この実体.生成( 歯車, 噛み音量, 3.5, 2 );
		};

		この型.生成 = function( 倍数, 強さ, 減衰の乗数, 次数の上限 )
		{
			let この実体 = this;
			let real = この実体.表[ 0 ];
			let imag = この実体.表[ 1 ];

			for( let n = 1; n <= 次数の上限; n ++ )
			{
				let n2 = n * 倍数;
				if( n2 > real.length )  break;

				real[ n * 倍数 ] += 強さ / Math.pow( n, 減衰の乗数 );
				//imag[ n ] += 0;
			}
		};

		この型.生成3 = function( 強さ )
		{
			let この実体 = this;
			let real = [ 0 ], imag = [ 0 ];
			for( let n = 1, m = 1; n <= 次数; n ++ )
			{
				if( n == m )
				{
					real[ n ] = 強さ;
					m *= 2;
				}
				else real[ n ] = 0;
				imag[ n ] = 0;
			}
			return この実体.構成表集[ 表名 ] = [ real, imag ];
		};

		この型.和合 = function( 表番号1, 表番号2 )
		{
			let この実体 = this;
		};

		この型.重合 = function( 表番号1, 表番号2 )
		{
			let この実体 = this;
		};

		この型._ = function( 表番号 )
		{
			let この実体 = this;
		};
	}
);


//  //

//  //


</script>
</body>
</html>