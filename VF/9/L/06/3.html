<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"/>
<title>横断歩道 1</title>
<link rel="stylesheet" href="Common.css"/>
<style>

.Pad
{
	padding: 50px;
	text-align: center;
}

.Button
{
	display: inline-block;
	margin: 0 40px;
	width: 100px; height: 100px;
	border: 1px solid hsl( 0, 0%, 30% );
}

</style>
</head>

<body onload="const アプリケーション = new アプリケーション型()">

<script>

const 旋律 =
[
	[ 64, 96 ], [ 64, 48 ], [ 62, 48 ], [ 64, 48 ], [ 64, 24 ], [ 62, 24 ], [ 59, 96 ]
];


const アプリケーション型 = function()
{
	const この実体 = this;

	この実体.初期化 = function()
	{
		const 音響文脈 = new AudioContext();
		const 残響器 = new 残響1型( 音響文脈, 音響文脈.destination );
		const 音源1 = new 音源1型( 音響文脈, 残響器.入力, 2, 10 );
		const 演奏機 = new 演奏機型( 音源1 );
		
		{
			const 主エレメント = エレメントを作成( "div", document.body, { クラス: "Pad" } );
			new 操作盤1型( 主エレメント, 演奏機 );
		}
	};

	この実体.初期化();
};

const 操作盤1型 = function( 幹エレメント, 演奏機 )
{
	const この実体 = this;

	この実体.初期化 = function()
	{
		const ボタン = ボタンを作成( "鳴動", 幹エレメント, 演奏機 );
	};

	function ボタンを作成( ラベル, 幹エレメント, 演奏機 )
	{
		const ボタン = エレメントを作成( "span", 幹エレメント, { 文: "鳴動", クラス: "Button" } );
		let 演奏中 = いいえ;

		function 操作処理()
		{
			if( 演奏中 == いいえ )
			{
				演奏中 = はい;
				演奏機.指令を投函( { 種類: "開始" } );
			}
			else
			{
				演奏中 = いいえ;
				演奏機.指令を投函( { 種類: "中断" } );
			}
		}

		ボタン.addEventListener
		(
			"touchstart",
			( ev ) =>
			{
				if( ev.cancelable )  ev.preventDefault();
				else console.log( "キャンセル不可" );
				操作処理();
			}
		);

		ボタン.addEventListener( "mousedown", ( ev ) => 操作処理() );

		return ボタン;
	}

	この実体.初期化();
};

// 音響 //

const 演奏機型 = function( 音源 )
{
	const この実体 = this;

	この実体.テンポ = 120;

	let 演奏中 = いいえ;

	//  //

	この実体.指令を投函 = function( 指令 )
	{
		switch( 指令.種類 )
		{
			case "開始":
				音源.指令を投函( { 種類: "押鍵" } );
				break;
				
			case "中断":
				音源.指令を投函( { 種類: "離鍵" } );
				break;
		}
	};

	const 秒間クロック数 = 20;
	const 全音符ビート数 = 192;

	let テンポカウンタ = 0;
	
	function クロック処理()
	{
		;
	}

	let 音符長カウンタ = 0;

	function ビート処理()
	{
		;
	}

	setInterval( クロック処理, 1000 / 20 );
};

const 音源1型 = function( 音響文脈, 送り先, 音程, 変調速度 )
{
	const この実体 = this;

	この実体.初期化 = function( 音響文脈 )
	{
		この実体.音響文脈 = 音響文脈;

		// ノード生成 //

		この実体.音声発振 = この実体.音響文脈.createOscillator();
		この実体.音声制幅 = この実体.音響文脈.createGain();

		この実体.音声2発振 = この実体.音響文脈.createOscillator();

		この実体.変調発振 = この実体.音響文脈.createOscillator();
		この実体.変調制幅 = この実体.音響文脈.createGain();

		// 値の設定 //

		この実体.音声発振.frequency.value = 440;
		この実体.音声発振.detune.value = ( 0 * 1200 + ( 音程 + 3 ) * 100 );
		この実体.音声発振.type = "square";
		この実体.音声制幅.gain.value = 0.0;
		
		この実体.音声2発振.detune.value = ( 0 * 1200 + 7 * 100 );
		この実体.音声2発振.type = "square";
		
		この実体.変調発振.frequency.value = 変調速度;
		この実体.変調発振.type = "square";
		//この実体.変調制幅.gain.value = 200 * 1.1822;
		
		
		// 接続 //

		この実体.音声発振.connect( この実体.音声制幅 );
		この実体.音声制幅.connect( 送り先 );

		// この実体.音声2発振.connect( この実体.音声制幅 );

		この実体.変調発振.connect( この実体.変調制幅 );
		この実体.変調制幅.connect( この実体.音声発振.detune );

		//  //

		この実体.音声発振.start();
		この実体.音声2発振.start();
		この実体.変調発振.start();
	};

	この実体.指令を投函 = function( 指令 )
	{
		switch( 指令.種類 )
		{
			case "押鍵":  この実体.打鍵( 指令 );  break;
			case "離鍵":  この実体.離健( 指令 );  break;
		}
	};

	この実体.打鍵 = function( 指令 )
	{
		if( この実体.音響文脈.state == "suspended" )
		{
			この実体.音響文脈.resume();
		}

		const 音量 = 0.14;
		const 開始時刻 = この実体.音響文脈.currentTime + 0.001;
		この実体.音声制幅.gain.setTargetAtTime( 音量 / 0.63, 開始時刻, 0.001 );
	};

	この実体.離健 = function( 指令 )
	{
		const 開始時刻 = この実体.音響文脈.currentTime + 0.001;
		この実体.音声制幅.gain.setTargetAtTime( 0, 開始時刻, 0.001 );
	};

	この実体.初期化( 音響文脈 );
};

const 残響1型 = function( 音響文脈, 送り先 )
{
	const この実体 = this;
	
	const 入力制幅 = 音響文脈.createGain();
	const 変調1発振 = 音響文脈.createOscillator();
	const 変調1制幅 = 音響文脈.createGain();
	const 濾過器1 = 音響文脈.createBiquadFilter();
	const 遅延器1 = 音響文脈.createDelay();
	const 帰還制幅11 = 音響文脈.createGain();
	const 帰還制幅12 = 音響文脈.createGain();
	const 遅延器2 = 音響文脈.createDelay();
	const 帰還制幅21 = 音響文脈.createGain();
	const 帰還制幅22 = 音響文脈.createGain();
	const 混合器 = 音響文脈.createChannelMerger();
	const 残響制幅 = 音響文脈.createGain();
	const 原音制幅 = 音響文脈.createGain();
	const 出力制幅 = 音響文脈.createGain();
	
	変調1発振.frequency.value = 1 / 5;
	変調1制幅.gain.value = 100;
	濾過器1.type = "bandpass";
	濾過器1.frequency.value = 1870;
	濾過器1.Q.value = 0.7;
	遅延器1.delayTime.value = 0.157;
	遅延器2.delayTime.value = 0.137;
	原音制幅.gain.value = 1.0;
	残響制幅.gain.value = 0.20;
	帰還制幅11.gain.value = 0.00;
	帰還制幅12.gain.value = 0.08;
	帰還制幅22.gain.value = 0.00;
	帰還制幅21.gain.value = 0.08;

	入力制幅.connect( 原音制幅 );
	入力制幅.connect( 濾過器1 );
	
	変調1発振.connect( 変調1制幅 );
	変調1制幅.connect( 濾過器1.detune );

	濾過器1.connect( 遅延器1 );
	濾過器1.connect( 遅延器2 );

	遅延器1.connect( 帰還制幅11 );
	遅延器1.connect( 帰還制幅12 );
	遅延器1.connect( 混合器, 0, 0 );
	帰還制幅11.connect( 遅延器1 );
	帰還制幅12.connect( 遅延器2 );

	遅延器2.connect( 帰還制幅21 );
	遅延器2.connect( 帰還制幅22 );
	遅延器2.connect( 混合器, 0, 1 );
	帰還制幅22.connect( 遅延器2 );
	帰還制幅21.connect( 遅延器1 );
	
	混合器.connect( 残響制幅 );
	残響制幅.connect( 出力制幅 );
	原音制幅.connect( 出力制幅 );
	出力制幅.connect( 送り先 );

	変調1発振.start();

	この実体.入力 = 入力制幅;
};

// 汎用 //

const はい = true;
const いいえ = false;
const 虚 = undefined;
const 無 = null;

function エレメントを作成( 型名, 幹エレメント, 設定 )
{
	const エレメント = document.createElement( 型名 );
	if( 設定 )
	{
		if( 設定.クラス != null ) エレメント.className = 設定.クラス;
		if( 設定.文 != null ) エレメント.innerHTML = 設定.文;
	}
	if( 幹エレメント ) 幹エレメント.appendChild( エレメント );
	return エレメント;
};

</script>
</body>
</html>