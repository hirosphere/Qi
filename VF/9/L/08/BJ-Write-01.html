<!doctype html>
<!--
Copyright 2017 JellyWare Inc. All Rights Reserved.
-->
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="BlueJelly">
    <meta name="viewport" content="width=640, maximum-scale=1.0, user-scalable=yes">
    <title>BJ-Write-01</title>
    <link href="https://fonts.googleapis.com/css?family=Lato:100,300,400,700,900" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="style.css">
    <script type="text/javascript" src="bluejelly.js"></script>
  </head>

<body>
<div class="container">
    <div class="title margin">
        <p id="title">BlueJelly Sample</p>
        <p id="subtitle">Writeでデータ書き込み</p>
    </div>

    <div class="contents margin">
      <input id="write_value" class="button" value="1" size="1">
      <button id="write" class="button">Write</button>
      <button id="sig_r" class="button">R</button>
      <button id="sig_yy" class="button">YY</button>
      <button id="sig_y" class="button">Y</button>
      <button id="sig_yg" class="button">YG</button>
      <button id="sig_g" class="button">G</button>
      <button id="sig_bl" class="button">Bl</button>
      <br/>
      <input id="int" class="button" value="1000" size="1">
      <button id="test" class="button" title="くり返し書き込みテスト">Test</button>
    <hr>
        <div id="device_name"> </div>
        <div id="uuid_name"> </div>
        <div id="status"> </div>

    </div>
    <div class="footer margin">
                For more information, see <a href="http://jellyware.jp/kurage" target="_blank">jellyware.jp</a> and <a href="https://github.com/electricbaka/bluejelly" target="_blank">GitHub</a> !
    </div>
</div>
<script>
//--------------------------------------------------
//Global変数
//--------------------------------------------------
//BlueJellyのインスタンス生成
var ble = new BlueJelly();


//--------------------------------------------------
//ロード時の処理
//--------------------------------------------------
window.onload = function () {
  //UUIDの設定
  ble.setUUID
  (
    "UUID2",
    "5867d7e4-13e4-4c83-ab38-9297acab7691",
    "378bf01f-9969-432a-889e-d2e5373835b9"
  );  //BLEnano SimpleControl rx_uuid
}


//--------------------------------------------------
//Scan後の処理
//--------------------------------------------------
ble.onScan = function (deviceName) {
  document.getElementById('device_name').innerHTML = deviceName;
  document.getElementById('status').innerHTML = "found device!";
}


//--------------------------------------------------
//ConnectGATT後の処理
//--------------------------------------------------
ble.onConnectGATT = function (uuid) {
  console.log('> connected GATT!');

  document.getElementById('uuid_name').innerHTML = uuid;
  document.getElementById('status').innerHTML = "connected GATT!";
}

//--------------------------------------------------
//Write後の処理
//--------------------------------------------------
ble.onWrite = function(uuid){
  document.getElementById('uuid_name').innerHTML = uuid;
  document.getElementById('status').innerHTML = "written data"
}


//-------------------------------------------------
//ボタンが押された時のイベント登録
//--------------------------------------------------
document.getElementById('write').addEventListener('click', function() {
    ble.write('UUID2', document.getElementById('write_value').value);
});

//  信号  //

function sig_button( id, patt )
{
   const bu = document.getElementById( id );
   bu.onclick = () => ble.write('UUID2', patt );
}

sig_button( "sig_r", "2." );
sig_button( "sig_yy", "9.." );
sig_button( "sig_y", "4..." );
sig_button( "sig_yg", "5...." );
sig_button( "sig_g", "1....." );
sig_button( "sig_bl", "0......   0......   0......   0......   0......   0......   0......   0......   0......   0......   " );


// 更新テスト //

let iid = 0;
let ph = 0;
const patt = [ "1", "0", "2", "9", "4", "5" ];
const pad = "........  ........  ........  ........  ........  ";

const test_op = () =>
{
    ble.write('UUID2', patt[ ph ] + pad );
    if( ++ ph >= patt.length ) ph = 0;
}

document.getElementById('test').onclick = () =>
{
    if( iid ) iid = clearInterval( iid );
    else iid = setInterval( test_op, document.getElementById( "int" ).value - 0 );

}


</script>
</body>
</html>
