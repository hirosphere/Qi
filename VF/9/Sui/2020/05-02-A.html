<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<title></title>
		<link rel="stylesheet" href="Style.css"/>
<style>

h1 { font-size: 30px; }

section { margin-bottom: 0px; }
table { border: 1px solid hsl( 0, 0%, 60% );  border-collapse: collapse; }
td { border: 1px dotted hsl( 210, 0%, 70% );  padding: 0 0.7ex; }
button { padding: 1.8ex 1.8em; font-size: 16px; }

.CONTENT { margin-bottom: 10px; }
.CONTENT .BODY { padding: 20px 20px; }

.CONTROL { margin-bottom: 5px; min-height: 30px; }
.OUTPUT { background: hsl( 210, 8%, 38% ); padding: 20px; border-radius: 6px; font-size: 12px; }
.OUTPUT p { font-family: 'Segoe UI', Tahoma, Geneva, Verdana; color: hsl( 210, 90%, 86% ); }
.OUTPUT .BSEP { margin-bottom: 20px; }

#Editor
{
	box-sizing: content-box; width: 600px; height: 400px;
	background: hsl( 55, 55%, 99% ); color: hsl( 210, 8%, 0% );
	font-size: 16px;
}
#Editor.ERROR { background-color: hsl( 200, 85%, 80% );  color: hsl( 0, 0%, 0% ); }

</style>
	<script src="URON3.js"></script>
	<script src="VF-05-03.js"></script>
	<script src="VF-05-03-Tra.js"></script>
</head>
	<body style="width: 800px;" onload="new App()">
		<section class="CONTENT">
			<header>
				<h1 id="Title"></h1>
				<p id="Caption"></p>
			</header>
			<section class="CONTROL">
				<button id="Start">開始</button>
				<button id="Stop">中断</button>
				<label>音量</label>
				<input id="Volume" type="range" min="0" max="100" style="width: 280px;"/>
			</section>
			<section class="INFO"><p id="Vars"></p></section>
			<section class="INFO"><p id="Info_1"></p></section>
		</section>

		<section>
			<textarea id="Editor"></textarea>
		</section>

		<section class="INFO"><p id="Pars"></p></section>

		<section>
			<canvas id="Graph" width="600" height="600"></canvas>
		</section>

		<section class="CONTROL">
			<a href="./" target="_blank" id="NewTab">新規タブで開く</a>
		</section>

		<section class="OUTPUT">
			<p id = "Output-1" title="Value -> URON"></p>
			<div class="BSEP"></div>
			<p id = "Output-2" title="URON -> Value -> URON"></p>
		</section>

<script>

const App = function()
{
	const newtab = document.getElementById( "NewTab" );
	const editor = document.getElementById( "Editor" );
	const output_1 = document.getElementById( "Output-1" );
	const output_2 = document.getElementById( "Output-2" );

	const doc_init_v_2 =
	{
		"表題": "VFラボ",
		"説明": "設定と指令の仕様。",
		"運転": [ [ "加速度", 3, 120 ], [ "惰行", 5 ], [ "加速度", 3, 0 ], [ "停止", 10 ] ],
		"動力設定":
		{
			"種類": "VVVF",

			"車輪径": 860,
			"車輪歯数": 84,
			"電動機歯数": 15,
			
			"電力飽和速度": 180,
			"電力変動緩和時間": 1,

			"誘導すべり率": 2,
			"切り替え": [ [ 6, 0, 150, 160 ], [ 12, 27 ], [ 20, 15 ], [ 30, 9 ], [ 50, 3 ] ],
		},
		"音響1": { "周波数": 400, "共振": 0 }
	};

	const doc_init_v_1 =
	{
		"表題": "PWMテスト",
		"説明": "アンチエイリアスと小数段",
		"運転": [ [ 30, 0, 100 ], [ 2, 100, 100 ], [ 30, 100, 0 ] ],
		"動力設定":
		{
			"種類": "PWM",
			"切り替え": [ [ 0.8, 150 ], [ 1.6, 300 ], [ 2.4, 600 ], [ 3.6, 900 ] ],
			//"切り替え": [ [ 2, 150 ], [ 98, 300 ], [ 100, 150 ] ],
		},
		"駆動": { "歯数": [ 16, 83 ], "車輪径": 810 },
		"音響1": { "周波数": 400, "共振": 0 }
	};

	const doc_init_v = doc_init_v_2;

	const uron = new URON( "#?", "v" );

	const CS = new Perm.ClassSet( 型定義群 );
	const doc = CS.Doc();
	const sgen = new VF.SoundGen( doc );
	const canvas = document.getElementById( "Graph" );
	const graph = new VF.Graph( canvas, sgen.WaveMonitor );

	newtab.href = location;

	const table_1 = new Table
	(
		document.getElementById( "Info_1" ),
		sgen.Proc.Pars,
		[
			[
				[ "指令加速度", "km/h/s", 0, 1, "acc" ],
				[ "時速", "km/h", 0, 1, "speed" ],
				[ "電力", "%", 0, 100, "power" ],
				[ "=車輪回転", "Hz", 1, 1, "wheel" ],
				[ "=モーター回転", "Hz", 0, 1, "motor" ],
				[ "=交流駆動周波数", "Hz", 0, 1, "vf_drv_freq" ],
				[ "=キャリア倍数", "", (vs)=>vs.vf_carr_rate != 0 ? vs.vf_carr_rate : "非同期", 1, "vf_carr_rate" ],
				[ "=キャリア周波数", "Hz", 0, 1, "vf_carr_freq" ],
			],
			[
				[ "<車輪径>", "mm", 0, 1, "wh_dia" ],
				[ "<=車輪周>", "mm", 0, 1, "wh_circ" ],
				[ "<=歯数比>", "", 2, 1, "mo_redr" ],
				[ "<車輪歯数>", "", 0, 1, "wh_gear" ],
				[ "<モーター歯数>", "", 0, 1, "mo_gear" ],
				[ "<電力飽和速度>", "km/h", 0, 1, "pw_sat" ],
				[ "<電力変動緩和時間>", "秒", 0, 1, "pw_relax" ],
				[ "<交流駆動すべり率>", "%", 1, 1, "vf_slip" ],
			],
		]
	);

	const load = () =>
	{
		doc.SetPerm( uron.復元( location.hash ) || doc_init_v );
		const perm = doc.GetPerm();
		editor_update( perm );
		view_update( perm );
	};

	const view_update = ( perm ) =>
	{
		document.title =
			document.getElementById( "Title" ).textContent = doc.表題;
		document.getElementById( "Caption" ).textContent = doc.説明;

		//    //
		history.replaceState( null,  "" , uron.変換( perm ) );
		newtab.href = location;

		sgen.Update();
		disp_update();
		monitor_update( perm );
	};

	const disp_update = () =>
	{
		const vars = sgen.GetTrainVars();
		table_1.Update();
	};

	const ft = ( v, d ) => { const s = Math.pow( 10, d ); return Math.floor( v * s ) / s; }; 

	const monitor_update = ( perm ) =>
	{
		let uron_str = output_1.textContent = uron.変換( perm );
		let obj = uron.復元( uron_str );
		output_2.textContent = JSON.stringify( obj );
	};

	const editor_update = ( perm ) =>
	{
		editor.value = JSON.stringify( perm, null, "\t" );
	};

	const editor_cure = () =>
	{
		if( editor.value.length == 0 )
		{
			const perm = doc.GetPerm();
			editor_update( perm );
		}

		else if( editor.value == "init" )
		{
			doc.SetPerm( doc_init_v );
			const perm = doc.GetPerm();
			editor_update( perm );
		}
		
		let value, is_err = false;
		try
		{
			doc.SetPerm( JSON.parse( editor.value ) );
			view_update( doc.GetPerm() );
		}
		catch( exc ) { is_err = true; }
		editor.classList.toggle( "ERROR", is_err );
	};

	editor.onkeydown = ( ev ) =>
	{
		if( ev.keyCode != 13 ) return true;
		editor_cure();
		return false;
	};

	editor.onblur = () => editor_cure();

	document.getElementById( "Start" ).onclick = () => sgen.Start();
	document.getElementById( "Stop" ).onclick = () => sgen.Stop();
	{
		const e = document.getElementById( "Volume" );
		e.value = sgen.Volume;
		e.oninput = () =>
		{
			sgen.Volume = e.value;
			sgen.Update();
		};
	}
	
	load();

	const graph_update = () =>
	{
		graph.Update();
		requestAnimationFrame( graph_update );
	};

	setInterval( disp_update, 1000 / 5 * 1 );
	//setInterval( () => graph.Update(), 1000 / 20 * 1 );
	canvas.onclick = () => graph.Update();

	//graph_update();
};

//  //

const 型定義群 =
{
	Doc:
	{
		Items:
		{
			"表題": { Type: "string" },
			"説明": { Type: "string" },
			"運転": { Type: "any" },
			"動力設定": { Type: "動力設定" },
			"音響1": { Type: "Filter" }
		},
	},

	"動力設定":
	{
		Items:
		{
			"種類": { Type: "string" },

			"車輪径": { Type: "number" },
			"車輪歯数": { Type: "number" },
			"電動機歯数": { Type: "number" },
			
			"電力変動緩和時間": { Type: "number" },
			"電力飽和速度": { Type: "number" },
			"誘導すべり率": { Type: "number" },
			
			"切り替え": { Type: "any" }
		}
	},

	Filter:
	{
		Items:
		{
			"周波数": { Type: "number", Default: 350 },
			"共振": { Type: "number", Default: 0 },
		}
	},
	Logs:
	{
		ItemType: "Log"
	},
	Log:
	{
		Items:
		{
			Date: { Type: "string", Default: "?Date" },
			Text: { Type: "string", Default: "??Text" }
		}
	}
};

//  //

const ecr = ( type, com, text ) =>
{
	const e = document.createElement( type );
	com && com.appendChild( e );
	if( text != null ) e.innerText = text;
	return e;
};

const Table = function( com, data, def )
{
	const table = ecr( "table", com );
	const tbody = ecr( "tbody", table );

	let rmax = 0;   for( let item of def ) rmax = Math.max( rmax, item.length );

	const cols = [];

	this.Update = () => { for( col of cols )  col.update(); };

	const Col = function( tr, def )
	{
		const caption = def && def[ 0 ] || "";
		const unit = def && def[ 1 ] || "";
		const fnc = def && def[ 2 ].constructor == Function && def[ 2 ] || null;
		const frac = def && fnc == null && Math.pow( 10, def[ 2 ] || 0 );
		const per = def && def[ 3 ] || 1;
		const name = def && def[ 4 ] || "";

		ecr( "td", tr, caption );
		const v = ecr( "td", tr );
		//ecr( "td", tr, def ? def[ 1 ] : "" );

		this.update = () =>
		{
			v.innerText = ( fnc ? fnc( data ) : ft( data[ name ] * per, frac ) + unit );
		};

		if( def )
		{
			this.update();
			cols.push( this );
		}
	};

	const ft = ( v, d ) => Math.round( v * d ) / d;
	
	for( let rx = 0; rx < rmax; rx ++ )
	{
		const tr = ecr( "tr", tbody );

		for( let raws of def )
		{
			new Col( tr, raws[ rx ] );
		}
	}
};



//  //

const Perm = new function()
{
	this.ClassSet = function( class_defs )
	{
		const set = this;

		for( let name in class_defs )
		{
			const class_def = class_defs[ name ];
			
			if( "Items" in class_def )  this[ name ] = function( init_vs )
			{
				const rt = {};  PermFields.call( rt, set, class_def, init_vs );  return rt;
			};

			else if( "ItemType" in class_def )  this[ name ] = function( init_vs )
			{
				const rt = {};  PermArray.call( rt, set, class_def, init_vs );  return rt;
			}
		}
	};

	const inits =
	{
		"string": ( v ) => v != null ? String( v ) : "",
		"number": ( v ) => v != null ? Number( v ) : 0,
		"bool": Boolean,
		"any": ( v ) => v
	};

	function PermFields( set, class_def, init_vs )
	{
		const item_defs = class_def.Items;
		const init_fns = {};

		const init = () =>
		{
			for( let name in item_defs )
			{
				const item_def = item_defs[ name ];
				const type = item_def.Type;
				
				const creator = set[ type ];
				if( creator )  this[ name ] = creator();
				else init_fns[ name ] = inits[ type ] || inits.any;
			}
			init_vs && this.SetPerm( init_vs );
		};

		this.SetPerm = function( values )
		{
			values = values || {};
			for( let name in item_defs )
			{
				const item_def = item_defs[ name ];
				const value =
				(
					name in values ? values[ name ] : item_def.Default
				);
				const init_fn = init_fns[ name ];

				// console.log( "F Set", name, init_fn, value, name in values );

				if( init_fn )  this[ name ] = init_fn( value );
				else this[ name ].SetPerm( value );
			};
		};

		this.GetPerm = function()
		{
			const rt = {};
			for( let name in item_defs )
			{
				const item_def = item_defs[ name ];
				const item = this[ name ];
				rt[ name ] = ( item && item.GetPerm ? item.GetPerm() : item );

				// console.log( "GetPerm", name, rt[ name ] );

			}
			return rt;
		};

		init();
	};

	function PermArray( set, class_def, init_vs )
	{
		const item_creator = set[ class_def.ItemType ] || inits.any;

		const init = () => 0;

		this.SetPerm = function( values )
		{
			console.log( "A Set", values )
			
			this.length = 0;
			if( values && values.constructor != Array ) return;
			for( let i in values )  this[ i ] = item_creator( values[ i ] );
		};

		this.GetPerm = function()
		{
			const rt = [];
			for( let i in this )
			{
				const item = this[ i ];
				rt[ i ] = ( item && item.GetPerm ? item.GetPerm() : item );
			}
			return rt;
		};

		init();
	};
};

</script>

	</body>
</html>
