<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<title></title>
		<link rel="stylesheet" href="Style.css"/>
<style>

h1 { font-size: 30px; }

section { margin-bottom: 0px; }
button { padding: 1.8ex 1.8em; font-size: 16px; }

.CONTENT { margin-bottom: 10px; }
.CONTENT .BODY { padding: 20px 20px; }

.CONTROL { margin-bottom: 5px; min-height: 30px; }
.OUTPUT { background: hsl( 210, 8%, 38% ); padding: 20px; border-radius: 6px; font-size: 12px; }
.OUTPUT p { font-family: 'Segoe UI', Tahoma, Geneva, Verdana; color: hsl( 210, 90%, 86% ); }
.OUTPUT .BSEP { margin-bottom: 20px; }

#Editor
{
	box-sizing: content-box; width: 600px; height: 400px;
	background: hsl( 185, 35%, 95% ); color: hsl( 210, 8%, 14% );
	font-size: 19px;
}
#Editor.ERROR { background-color: hsl( 195, 60%, 80% );  color: hsl( 0, 0%, 100% ); }

</style>
	<script src="URON3.js"></script>
	<script src="VF-05-03.js"></script>
	<script src="VF-05-03-Tra.js"></script>
</head>
	<body style="width: 800px;" onload="new App()">
		<section class="CONTENT">
			<header>
				<h1 id="Title"></h1>
				<p id="Caption"></p>
			</header>
			<section class="CONTROL">
				<button id="Start">開始</button>
				<button id="Stop">中断</button>
				<label>音量</label>
				<input id="Volume" type="range" min="0" max="100" style="width: 280px;"/>
			</section>
			<section class="INFO"><p id="Vars"></p></section>
			<section class="INFO"><p id="Pars"></p></section>
		</section>

		<section>
			<textarea id="Editor"></textarea>
		</section>

		<section>
			<canvas id="Graph" width="600" height="600"></canvas>
		</section>

		<section class="CONTROL">
			<a href="./" target="_blank" id="NewTab">新規タブで開く</a>
		</section>

		<section class="OUTPUT">
			<p id = "Output-1" title="Value -> URON"></p>
			<div class="BSEP"></div>
			<p id = "Output-2" title="URON -> Value -> URON"></p>
		</section>

<script>

const App = function()
{
	const newtab = document.getElementById( "NewTab" );
	const editor = document.getElementById( "Editor" );
	const output_1 = document.getElementById( "Output-1" );
	const output_2 = document.getElementById( "Output-2" );

	const doc_init_v_2 =
	{
		"表題": "VFラボ",
		"説明": "設定と指令の仕様。",
		"運転": [ [ "加速度", 3, 120 ], [ "惰行", 5 ], [ "加速度", 3, 0 ], [ "停止", 10 ] ],
		"動力設定":
		{
			"種類": "VVVF",

			"車輪径": 860,
			"車輪歯数": 15,
			"電動機歯数": 84,
			
			"電力飽和速度": 200,
			"電力変動緩和時間": 1,

			"誘導すべり率": 2,
			"切り替え": [ [ 6, 0, 150, 160 ], [ 12, 27 ], [ 20, 15 ], [ 30, 9 ], [ 50, 3 ] ],
		},
		"音響1": { "周波数": 400, "共振": 0 }
	};

	const doc_init_v_1 =
	{
		"表題": "PWMテスト",
		"説明": "アンチエイリアスと小数段",
		"運転": [ [ 30, 0, 100 ], [ 2, 100, 100 ], [ 30, 100, 0 ] ],
		"動力設定":
		{
			"種類": "PWM",
			"切り替え": [ [ 0.8, 150 ], [ 1.6, 300 ], [ 2.4, 600 ], [ 3.6, 900 ] ],
			//"切り替え": [ [ 2, 150 ], [ 98, 300 ], [ 100, 150 ] ],
		},
		"駆動": { "歯数": [ 16, 83 ], "車輪径": 810 },
		"音響1": { "周波数": 400, "共振": 0 }
	};

	const doc_init_v = doc_init_v_2;

	const uron = new URON( "#?", "v" );

	const CS = new Perm.ClassSet( 型定義群 );
	const doc = CS.Doc();
	const sgen = new VF.SoundGen( doc );
	const canvas = document.getElementById( "Graph" );
	const graph = new VF.Graph( canvas, sgen.WaveMonitor );

	newtab.href = location;

	const load = () =>
	{
		doc.SetPerm( uron.復元( location.hash ) || doc_init_v );
		const perm = doc.GetPerm();
		editor_update( perm );
		view_update( perm );
	};

	const disp_update = () =>
	{
		const vars = sgen.GetTrainVars();

		document.getElementById( "Vars" ).innerText =
		[
			"加速指令 : " + ft( vars.Acc, 1 ) + "km/h/s",
			"電力 : " + ft( vars.Power * 100, 0 ) + "%",
			"時速 : " + ft( vars.Speed, 1 ) + "km/h",
			"モーター : " + ft( vars.Motor, 1 ) + "Hz",
			"交流駆動 : " + ft( vars.ACDrive, 1 ) + "Hz",
		]
		 .join( "\n" );

		
		const parms = sgen.Train.GetParms();

		document.getElementById( "Pars" ).innerText =
		[
			"(車輪径) : " + ft( parms.whdia, 0 ) + "mm",
			"((車輪周)) : " + ft( parms.whcirc, 0 ) + "mm",
			"(車輪歯数) : " + ft( parms.whge, 0 ) + "",
			"(電動機歯数) : " + ft( parms.moge, 0 ) + "",
			"((減速比)) : " + ft( parms.redr, 2 ) + "",
			"(電力飽和速度) : " + ft( parms.psats, 2 ) + "km/h",
			"(電力変動緩和時間) : " + ft( parms.relax, 1 ) + "秒",
			"(誘導すべり率) : " + ft( parms.slip, 0 ) + "%",
		]
		 .join( "\n" );
	};

	const ft = ( v, d ) => { const s = Math.pow( 10, d ); return Math.floor( v * s ) / s; }; 

	const view_update = ( perm ) =>
	{
		document.title =
			document.getElementById( "Title" ).textContent = doc.表題;
		document.getElementById( "Caption" ).textContent = doc.説明;

		//    //
		history.replaceState( null,  "" , uron.変換( perm ) );
		newtab.href = location;

		sgen.Update();
		monitor_update( perm );
	};

	const monitor_update = ( perm ) =>
	{
		let uron_str = output_1.textContent = uron.変換( perm );
		let obj = uron.復元( uron_str );
		output_2.textContent = JSON.stringify( obj );
	};

	const editor_update = ( perm ) =>
	{
		editor.value = JSON.stringify( perm, null, "\t" );
	};

	const editor_cure = () =>
	{
		if( editor.value[ 0 ] == "r" )
		{
			const perm = doc.GetPerm();
			editor_update( perm );
		}

		if( editor.value.length == 0 )
		{
			doc.SetPerm( doc_init_v );
			const perm = doc.GetPerm();
			editor_update( perm );
		}
		
		let value, is_err = false;
		try
		{
			doc.SetPerm( JSON.parse( editor.value ) );
			view_update( doc.GetPerm() );
		}
		catch( exc ) { is_err = true; }
		editor.classList.toggle( "ERROR", is_err );
	};

	editor.onkeydown = ( ev ) =>
	{
		if( ev.keyCode != 13 ) return true;
		editor_cure();
		return false;
	};

	editor.onblur = () => editor_cure();

	document.getElementById( "Start" ).onclick = () => sgen.Start();
	document.getElementById( "Stop" ).onclick = () => sgen.Stop();
	{
		const e = document.getElementById( "Volume" );
		e.value = sgen.Volume;
		e.oninput = () =>
		{
			sgen.Volume = e.value;
			sgen.Update();
		};
	}
	
	load();

	const graph_update = () =>
	{
		graph.Update();
		requestAnimationFrame( graph_update );
	};

	setInterval( disp_update, 1000 / 4 * 1 );
	//setInterval( () => graph.Update(), 1000 / 20 * 1 );
	canvas.onclick = () => graph.Update();

	//graph_update();
};

//  //

const 型定義群 =
{
	Doc:
	{
		Items:
		{
			"表題": { Type: "string" },
			"説明": { Type: "string" },
			"運転": { Type: "any" },
			"動力設定": { Type: "動力設定" },
			"音響1": { Type: "Filter" }
		},
	},

	"動力設定":
	{
		Items:
		{
			"種類": { Type: "string" },

			"車輪径": { Type: "number" },
			"車輪歯数": { Type: "number" },
			"電動機歯数": { Type: "number" },
			
			"電力変動緩和時間": { Type: "number" },
			"電力飽和速度": { Type: "number" },
			"誘導すべり率": { Type: "number" },
			
			"切り替え": { Type: "any" }
		}
	},

	Filter:
	{
		Items:
		{
			"周波数": { Type: "number", Default: 350 },
			"共振": { Type: "number", Default: 0 },
		}
	},
	Logs:
	{
		ItemType: "Log"
	},
	Log:
	{
		Items:
		{
			Date: { Type: "string", Default: "?Date" },
			Text: { Type: "string", Default: "??Text" }
		}
	}
};

const Perm = new function()
{
	this.ClassSet = function( class_defs )
	{
		const set = this;

		for( let name in class_defs )
		{
			const class_def = class_defs[ name ];
			
			if( "Items" in class_def )  this[ name ] = function( init_vs )
			{
				const rt = {};  PermFields.call( rt, set, class_def, init_vs );  return rt;
			};

			else if( "ItemType" in class_def )  this[ name ] = function( init_vs )
			{
				const rt = {};  PermArray.call( rt, set, class_def, init_vs );  return rt;
			}
		}
	};

	const inits =
	{
		"string": ( v ) => v != null ? String( v ) : "",
		"number": ( v ) => v != null ? Number( v ) : 0,
		"bool": Boolean,
		"any": ( v ) => v
	};

	function PermFields( set, class_def, init_vs )
	{
		const item_defs = class_def.Items;
		const init_fns = {};

		const init = () =>
		{
			for( let name in item_defs )
			{
				const item_def = item_defs[ name ];
				const type = item_def.Type;
				
				const creator = set[ type ];
				if( creator )  this[ name ] = creator();
				else init_fns[ name ] = inits[ type ] || inits.any;
			}
			init_vs && this.SetPerm( init_vs );
		};

		this.SetPerm = function( values )
		{
			values = values || {};
			for( let name in item_defs )
			{
				const item_def = item_defs[ name ];
				const value =
				(
					name in values ? values[ name ] : item_def.Default
				);
				const init_fn = init_fns[ name ];

				// console.log( "F Set", name, init_fn, value, name in values );

				if( init_fn )  this[ name ] = init_fn( value );
				else this[ name ].SetPerm( value );
			};
		};

		this.GetPerm = function()
		{
			const rt = {};
			for( let name in item_defs )
			{
				const item_def = item_defs[ name ];
				const item = this[ name ];
				rt[ name ] = ( item && item.GetPerm ? item.GetPerm() : item );

				// console.log( "GetPerm", name, rt[ name ] );

			}
			return rt;
		};

		init();
	};

	function PermArray( set, class_def, init_vs )
	{
		const item_creator = set[ class_def.ItemType ] || inits.any;

		const init = () => 0;

		this.SetPerm = function( values )
		{
			console.log( "A Set", values )
			
			this.length = 0;
			if( values && values.constructor != Array ) return;
			for( let i in values )  this[ i ] = item_creator( values[ i ] );
		};

		this.GetPerm = function()
		{
			const rt = [];
			for( let i in this )
			{
				const item = this[ i ];
				rt[ i ] = ( item && item.GetPerm ? item.GetPerm() : item );
			}
			return rt;
		};

		init();
	};
};

</script>

	</body>
</html>
