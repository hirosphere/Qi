<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<title>Sui 2020-04-25 A</title>
		<link rel="stylesheet" href="Style.css"/>
<style>

section { margin-bottom: 20px; }
button { padding: 1.5ex 1.5em; }


.OUTPUT { background: hsl( 210, 8%, 38% ); padding: 20px; border-radius: 6px; font-size: 12px; }
.OUTPUT p { font-family: 'Segoe UI', Tahoma, Geneva, Verdana; color: hsl( 210, 90%, 86% ); }
.OUTPUT .BSEP { margin-bottom: 20px; }

#Editor { box-sizing: content-box; width: 100%; height: 100px; color: hsl( 210, 8%, 38% ); font-size: 15px; }

</style>
		<script src="Prime.js"></script>
		<script src="URON3.js"></script>
	</head>
	<body style="width: 800px;" onload="new App()">
		<header>
			<h1>Sui 2020-04-25</h1>
		</header>

		<section class="CONTROL">
			<button id="Load">URL取り込み</button>
			<button id="Save">URLに反映</button>
			<button id="Clear">消去</button>
		</section>

		<section>
			<textarea id="Editor"></textarea>
		</section>

		<section class="OUTPUT">
			<p id = "Output-1" title="Value -> URON"></p>
			<div class="BSEP"></div>
			<p id = "Output-2" title="URON -> Value -> URON"></p>
		</section>

<script>

const App = function()
{
	const editor = document.getElementById( "Editor" );
	const output_1 = document.getElementById( "Output-1" );
	const output_2 = document.getElementById( "Output-2" );

	const uron = new URON( "#?", "v" );

	const CS = new PermFields.ClassSet( PFDefinitions );
	const doc = new CS.Doc();
//	doc.SetPerm( { Title: "2レベルインバーター", Shape1: { ForeColor: { Type: "HSLA", Hue: 223 } }, Field2: "12333", Field3: "false" } );

	const load = () =>
	{
		doc.SetPerm( uron.復元( location.hash ) );
		editor_update();
		monitor_update();
	};

	const save = () =>
	{
		history.replaceState( null,  "" , uron.変換( doc.GetPerm() ) );
	};

	const clear = () =>
	{
		doc.SetPerm( null );
		history.replaceState( null,  "" , "#" );
		editor_update();
		monitor_update();
	};

	const editor_update = () =>
	{
		editor.value = JSON.stringify( doc.GetPerm() );
	};

	const editor_cure = () =>
	{
		let value;
		try { doc.SetPerm( JSON.parse( editor.value ) ); }
		catch( exc )
		{
			;
		}

		monitor_update();
	};

	const monitor_update = () =>
	{
		let uron_str = output_1.textContent = uron.変換( doc.GetPerm() );
		let obj = uron.復元( uron_str );
		output_2.textContent = JSON.stringify( obj );
	};

	editor.onkeydown = ( ev ) =>
	{
		if( ev.keyCode != 13 ) return true;
		editor_cure();
		return false;
	};
	
	document.getElementById( "Load" ).onclick = load;
	document.getElementById( "Save" ).onclick = save;
	document.getElementById( "Clear" ).onclick = clear;

	// monitor_update();
	load();
};


//  //

const PFDefinitions =
{
	Doc:
	{
		Items:
		{
			"Title":  { Type: "string", Init: "", Opt: "" },
			"Shape1": { Type: "Shape", Opt: null },
			"Field2": { Type: "number", Init: 0 },
			"Field3": { Type: "bool", Init: false, Opt: false },
		}
	},
	Shape:
	{
		Items:
		{
			"Title":     { Type: "string", Init: "shape" },
			"ForeColor": { Type: "any", Init: [ 0, 0, 0 ] }
		}
	}
};

const inits = { string: String, number: Number, bool: Boolean, any: ( v )=> v };

const PermFields = function( set, class_def, init_values )
{
	const field_defs = class_def.Items;
	for( let name in field_defs )
	{
		const field_def = field_defs[ name ];
		const type = field_def.Type;
		const ctor = set[ type ];
		const init_value =
		(
			init_values && name in init_values ? init_values[ name ]
				: "Init" in field_def ? field_def.Init
					: field_def.Opt
		);
		
		if( ctor )
		{
			this[ name ] = new ctor( init_value );
		}
		else
		{
			field_def.initfn = inits[ type ] || inits.any;
			this[ name ] = field_def.initfn( init_value );
		}

		console.log( name, this[ name ] + "" );
	}

	this.GetPerm = function()
	{
		const rt = {};
		for( let name in field_defs )
		{
			const field = this[ name ];
			rt[ name ] = ( field && field.GetPerm ? field.GetPerm() : field );
		}
		return rt;
	};

	this.SetPerm = function( values )
	{
		for( let name in field_defs )
		{
			const fd = field_defs[ name ];
			const def_v = ( "Opt" in fd ? fd.Opt : fd.Init );
			const value = ( values && name in values ? values[ name ] : def_v );
			if( this[ name ].SetPerm )  this[ name ].SetPerm( value );
			else this[ name ] = fd.initfn( value );
		}
	};
};

PermFields.ClassSet = function( definition )
{
	const set = this;
	for( let name in definition )
	{
		console.log( name );
		const ctor = this[ name ] = function( init_values )
		{
			PermFields.call( this, set, definition[ name ], init_values );
		};
		ctor.prototype.toString = function() { return name; };
	}
};

</script>

	</body>
</html>
