<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<title></title>
		<link rel="stylesheet" href="Style.css"/>
<style>

section { margin-bottom: 0px; }
button { padding: 1.5ex 1.5em; }

.CONTENT { margin-bottom: 40px; }
.CONTROL { margin-bottom: 5px; }
.OUTPUT { background: hsl( 210, 8%, 38% ); padding: 20px; border-radius: 6px; font-size: 12px; }
.OUTPUT p { font-family: 'Segoe UI', Tahoma, Geneva, Verdana; color: hsl( 210, 90%, 86% ); }
.OUTPUT .BSEP { margin-bottom: 20px; }

#Editor { box-sizing: content-box; width: 100%; height: 100px; color: hsl( 210, 8%, 38% ); font-size: 15px; }

</style>
		<script src="Prime.js"></script>
		<script src="URON3.js"></script>
	</head>
	<body style="width: 800px;" onload="new App()">
		<section class="CONTENT">
			<header>
				<h1 id="Title"></h1>
				<p id="Caption"></p>
			</header>
			<section class=""></section>
		</section>

		<section class="CONTROL">
			<a href="./" target="_blank" id="NewTab">新規タブで開く</a>
		</section>

		<section>
			<textarea id="Editor"></textarea>
		</section>

		<section class="OUTPUT">
			<p id = "Output-1" title="Value -> URON"></p>
			<div class="BSEP"></div>
			<p id = "Output-2" title="URON -> Value -> URON"></p>
		</section>

<script>

const App = function()
{
	const newtab = document.getElementById( "NewTab" );
	const editor = document.getElementById( "Editor" );
	const output_1 = document.getElementById( "Output-1" );
	const output_2 = document.getElementById( "Output-2" );

	const uron = new URON( "#?", "v" );

	const CS = new Perm.ClassSet( PFDefinitions );
	const doc = CS.Doc();
	newtab.href = location;

	const view_update = () =>
	{
		document.title =
		 document.getElementById( "Title" ).textContent = doc.Title;
		document.getElementById( "Caption" ).textContent = doc.Caption;
	};

	const load = () =>
	{
		doc.SetPerm( uron.復元( location.hash ) );
		editor_update();
		monitor_update();
		view_update();
	};

	const save = () =>
	{
		history.replaceState( null,  "" , uron.変換( doc.GetPerm() ) );
		newtab.href = location;
	};

	const clear = () =>
	{
		doc.SetPerm( null );
		history.replaceState( null,  "" , "#" );
		editor_update();
		monitor_update();
		view_update();
	};

	const editor_update = () =>
	{
		editor.value = JSON.stringify( doc.GetPerm() );
	};

	const editor_cure = () =>
	{
		if( editor.value.length == 0 )  editor.value = JSON.stringify( doc.GetPerm() );
		
		let value;
		try { doc.SetPerm( JSON.parse( editor.value ) ); }
		catch( exc )
		{
			;
		}

		monitor_update();
		view_update();
		save();
	};

	const monitor_update = () =>
	{
		let uron_str = output_1.textContent = uron.変換( doc.GetPerm() );
		let obj = uron.復元( uron_str );
		output_2.textContent = JSON.stringify( obj );
	};

	editor.onkeydown = ( ev ) =>
	{
		if( ev.keyCode != 13 ) return true;
		editor_cure();
		return false;
	};

	editor.onblur = () => editor_cure();
	
	// monitor_update();
	load();
};


//  20. 04. 29. C

//  //

const PFDefinitions =
{
	Doc:
	{
		Items:
		{
			"Title":  { Type: "string", Init: "", Opt: "" },
			"Caption":  { Type: "string", Init: "", Opt: "" },
			"Logs": { Type: "Logs" },
			//"Shape1": { Type: "Shape", Opt: null },
			//"Field2": { Type: "number", Init: 0 },
			//"Field3": { Type: "bool", Init: false, Opt: false },
		}
	},
	Logs: { ItemType: "Log" },
	Log:
	{
		Items:
		{
			Date: { Type: "string" }, Text: { Type: "string" }
		}
	},
	Shape:
	{
		Items:
		{
			"Title":     { Type: "string", Init: "shape" },
			"ForeColor": { Type: "any", Init: [ 0, 0, 0 ] }
		}
	}
};


const Perm = {};

const inits = { string: String, number: Number, bool: Boolean, any: ( v )=> v };

const PermFields = function( set, class_def, init_values )
{
	const field_defs = class_def.Items;
	for( let name in field_defs )
	{
		const field_def = field_defs[ name ];
		const type = field_def.Type;
		const ctor = set[ type ];
		const init_value =
		(
			init_values && name in init_values ? init_values[ name ]
				: "Init" in field_def ? field_def.Init
					: field_def.Opt
		);
		
		if( ctor )
		{
			this[ name ] = new ctor( init_value );
		}
		else
		{
			field_def.initfn = inits[ type ] || inits.any;
			this[ name ] = field_def.initfn( init_value );
		}

		console.log( name, this[ name ] + "" );
	}

	this.GetPerm = function()
	{
		const rt = {};
		for( let name in field_defs )
		{
			const field = this[ name ];
			rt[ name ] = ( field && field.GetPerm ? field.GetPerm() : field );
		}
		return rt;
	};

	this.SetPerm = function( values )
	{
		for( let name in field_defs )
		{
			const fd = field_defs[ name ];
			const def_v = ( "Opt" in fd ? fd.Opt : fd.Init );
			const value = ( values && name in values ? values[ name ] : def_v );
			if( this[ name ].SetPerm )  this[ name ].SetPerm( value );
			else this[ name ] = fd.initfn( value );
		}
	};
};

Perm.CreateFields = function( set, class_def, init_values )
{
	const rt = {};
	const field_defs = class_def.Items;
	for( let name in field_defs )
	{
		const field_def = field_defs[ name ];
		const type = field_def.Type;
		const ctor = set[ type ];
		const init_value =
		(
			init_values && name in init_values ? init_values[ name ]
				: "Init" in field_def ? field_def.Init
					: field_def.Opt
		);
		
		if( ctor )
		{
			rt[ name ] = ctor( init_value );
		}
		else
		{
			field_def.initfn = inits[ type ] || inits.any;
			rt[ name ] = field_def.initfn( init_value );
		}

		console.log( name, rt[ name ] + "" );
	}

	rt.GetPerm = function()
	{
		const rt = {};
		for( let name in field_defs )
		{
			const field = this[ name ];
			rt[ name ] = ( field && field.GetPerm ? field.GetPerm() : field );
		}
		return rt;
	};

	rt.SetPerm = function( values )
	{
		for( let name in field_defs )
		{
			const fd = field_defs[ name ];
			const def_v = ( "Opt" in fd ? fd.Opt : fd.Init );
			const value = ( values && name in values ? values[ name ] : def_v );
			if( this[ name ].SetPerm )  this[ name ].SetPerm( value );
			else this[ name ] = fd.initfn( value );
		}
	};

	return rt;
};

Perm.CreateArray = function( set, class_def, init_value )
{
	;
};

Perm.ClassSet = function( set_def )
{
	const set = this;

	for( let name in set_def )
	{
		console.log( name );
		const class_def = set_def[ name ];
		const ctor = this[ name ] = function( init_values )
		{
			return Perm.CreateFields( set, class_def, init_values );
			//PermFields.call( this, set, class_def, init_values );
		};
	}
};

</script>

	</body>
</html>
