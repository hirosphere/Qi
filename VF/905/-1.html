<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"/>
<title>VF905-1</title>
<style>
*
{
	margin: 0; padding: 0; color: #222;
	font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

html
{
}

body
{
}

.DIV1 { padding: 20px; }

button { padding: 16px 24px; }

</style>
</head>
<body onload="window.main = new Main();">

<div class="DIV1"><button onclick="main.start()">開始</button>
</div>

<script>

const version = "18.12.16 905 A";

const Main = function()
{
	const context = new AudioContext();
	const psg = new PWM( context, context.destination, 0.3 );
	const drive = new Drive( context, psg );

	this.start = function()
	{
		drive.start();
		context.resume();
	};
};

const Drive = function( context, sound )
{
	const drive = new ConstantSourceNode( context, { offset: 0 } );
	drive.connect( sound.power_in );
	drive.start();

	this.start = function()
	{
		const cur = context.currentTime;

		drive.offset.cancelAndHoldAtTime( cur );
		drive.offset.linearRampToValueAtTime( 1, cur + 20  );
		drive.offset.linearRampToValueAtTime( 1, cur + 25  );
		drive.offset.linearRampToValueAtTime( 0, cur + 45  );
	};

};

const PWM = function( context, dest, volume )
{
	const sc_pwm = context.createScriptProcessor( 4096, 1, 1 );
	const ga_out = new GainNode( context, { gain: volume } );
	const conv = create_conv1( context, ga_out );

	conv.connect( ga_out );
	ga_out.connect( dest );

	this.power_in = conv;

	const cur = context.currentTime;
};

const create_conv1 = function( context, dest )
{
	const sc_pwm = context.createScriptProcessor( 4096, 1, 1 );

	let phase = 0;
	const oversample = 8;

	sc_pwm.onaudioprocess = ( ev ) =>
	{
		const out = ev.outputBuffer.getChannelData( 0 );
		const inp = ev.inputBuffer.getChannelData( 0 );

		for( let i = 0; i < out.length; i ++ )
		{
			//out[ i ] = Math.random() * 2 - 1;
			const voltage = inp[ i ];
			const freq = eidan_freq( voltage );
			let step = freq / ( context.sampleRate * oversample );

			let acc = 0;
			for( let j = 0; j < oversample; j ++ )
			{
				const carr = phase % 1;
				phase += step;
				const s = voltage + carr;
				acc += ( s >= 1 ? 1 : 0 );
			}
			out[ i ] = acc / oversample;
		}
	};

	sc_pwm.connect( dest );
	return sc_pwm;
};

function eidan_freq( pw )
{
	const w = ( pw < 0.5 ? pw : 1 - pw );
	if( w < 0.02 ) return 150;
	if( w < 0.04 ) return 300;
	if( w < 0.06 ) return 600;
	return 900;
}

const settings =
{
	"pwm1": { type: "pwm", freq: [ [ null, 200 ] ] }
};

</script>
</body>
</html>