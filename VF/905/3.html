<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"/>
<title>ADSR</title>
<style>
*
{
	margin: 0; padding: 0; color: #222;
	font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

html
{
	background: hsl( 210, 80%, 90% );
	padding: 0px 40px;
}

body
{
	min-height: 200vh;
	background: hsl( 210, 0%, 100% );
	padding: 30px 40px;
}

.DIV1 { padding: 0px; }
.SEP { height: 10px; }
.VBOX { padding: 9px 0; }
.VLB { vertical-align: middle; }
button { margin-bottom: 10px; padding: 16px 24px; border-radius: 6px; }

#dummy { color: #fff; }

</style>

<script src="Prime905.js?2019-01-27-A"></script>
<script src="Cell.js?2019-01-27-A"></script>

</head>

<body onload="アプリケーション.初期化()">

<article style="margin-bottom: 60px;">
	<div>
		<button onclick="アプリケーション.ハッシュ取り込み()">URLハッシュ取り込み</button>
		<button onclick="アプリケーション.ハッシュ書き出し()">URLハッシュ書き出し</button>
		<button onclick="location.hash = ''">クリア</button>
		<br/>
		<button onclick="アプリケーション.シンセ.発音()">発音</button>
		<br/>
		<textarea id="JSON" style="width: 260px; height: 280px;"></textarea>
		<textarea id="UEnc" style="width: 120px; height: 280px;"></textarea>
		<textarea id="B64" style="width: 120px; height: 280px;"></textarea>
		<br/>
		<p id="Info"></p>
	</div>
</article>

<article class="EVAL">
	<button onclick="アプリケーション.スクリプト実行()">スクリプト実行</button><br/>
	<textarea id="Eval_Code" style="width: 500px; height: 80px;"></textarea>
	<textarea id="Eval_Output" style="width: 500px; height: 40px;"></textarea>
</article>

<script>

const アプリケーション = new function()
{
	const json = この文書.Idで( "JSON" );
	const uenc = この文書.Idで( "UEnc" );
	const b64 = この文書.Idで( "B64" );
	const info = この文書.Idで( "Info" );

	const def_doc_value =
	{
		Ti:"ハッシュドキュメント",Fs:[330,440],EG:{A:100,D:1000,S:50,R:100}
	};

	この世界.onhashchange = ()=> this.ハッシュ取り込み();
	json.oninput = () => this.テストビューを更新();
	

	this.初期化 = function()
	{
		this.Value = {};
		this.シンセ = new シンセの型();
		this.ハッシュ取り込み();
	};

	// ドキュメント //
	
	this.ハッシュ取り込み = function()
	{
		const new_doc_value = ( location.hash ? this.Value = JSON.parse( Base64から文字列に復元( location.hash.substr( 1 ) ) ) : null );
		オブジェクトの内容を書き換え( this.Value, new_doc_value, def_doc_value );

		this.ドキュメントを編集に反映();
		this.シンセ.保存値を設定( this.Value );
	};

	this.ハッシュ書き出し = function()
	{
		this.編集をドキュメントに反映();
		location.hash = "#" + 文字列からBase64に変換( JSON.stringify( this.Value ) );
		info.文を設定( location.hash.length );
		this.シンセ.保存値を設定( this.Value );
	};

	// 編集 //

	this.ドキュメントを編集に反映 = function()
	{
		json.value = JSON.stringify( this.Value, null, "\t" );
		this.テストビューを更新();
	};

	this.編集をドキュメントに反映 = function()
	{
		this.Value = JSON.parse( json.value );
	};
	
	this.テストビューを更新 = function()
	{
		const json = JSON.stringify( this.Value ) || "";
		uenc.value = encodeURI( json );
		b64.value = 文字列からBase64に変換( json );
		info.文を設定( `${ json.length } , ${ uenc.value.length } , ${ b64.value.length }` );
	};

	// テスト //
	
	this.スクリプト実行 = function()
	{
		const 出力 = この文書.Idで( "Eval_Output" );
		try
		{
			出力.value = eval( この文書.Idで( "Eval_Code" ).value );
		}
		catch( 例外 )
		{
			出力.value = 例外.toString();
		}
	};
};

//  //

const シンセの型 = function()
{
	//

	const def_param =
	{
		Fs: [ 330, 440 ],
		EG: { A: 250, D: 250, S: 40, R: 250 }
	};

	const param = {};

	オブジェクトの内容を書き換え( param, null, def_param );
	
	//
	const context = new AudioContext();
	const ga_total = context.createGain();
	ga_total.gain.value = 0.3;
	ga_total.connect( context.destination );
	const vo_1 = new ボイスの型( context, ga_total, param, 0 );

	this.発音 = function()
	{
		vo_1.発音();
	};

	this.保存値を設定 = function( 値 )
	{
		オブジェクトの内容を書き換え( param, 値, def_param );
	};

	this.保存値を取得 = function()
	{
		;
	};

};

const ボイスの型 = function( context, dest, param, ch )
{
	let osc;

	this.発音 = function()
	{
		osc = context.createOscillator();

		osc.frequency.value = param.Fs[ ch ];

		osc.connect( dest );

		const t = context.currentTime;
		osc.start( t + 0 );
		osc.stop( t + 1 );
	};
};

function オブジェクトの内容を書き換え( dest, src, def )
{
	for( let index in def )
	{
		const value = ( src ? src[ index ] : def[ index ] );

		if( value && value.constructor == Array )
			オブジェクトの内容を書き換え( dest[ index ] = dest[ index ] || [], value, def[ index ] );
		
		else if( value && value.constructor == Object )
			オブジェクトの内容を書き換え( dest[ index ] = dest[ index ] || {}, value, def[ index ] );
		
		else dest[ index ] = value;
	}
}


</script>
</body>
</html>