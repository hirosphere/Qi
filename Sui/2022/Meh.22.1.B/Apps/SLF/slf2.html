<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>

* { box-sizing: border-box; margin: 0; padding: 0; }

html
{
	overflow: scroll; 
	height: 100vh;
	background: linear-gradient( 180deg, hsl( 190, 75%, 95% ) 0%, hsl( 215, 60%, 80% ) 100% );
}

body
{
	margin: 0 auto;
	width: 800px; height: 100%; background: hsl( 50, 45%, 100% );
	padding: 1em 2em;
}

.Ranges
{
	gap: 1px;
	display: flex; flex-direction: column;
	justify-content:end;
}

.Range
{
	border-radius: 0.43ex;
	background:hsl( 270, 2%, 44% ); color:hsl( 50, 0%, 90% );
	display: grid;
	padding: 1.3ex 1.3ex;
	grid-template-columns: 12ex 400px 7ex 2ex;
}
.Range .value { margin-left: 1ex; text-align: right; }
.Range .unit { margin-left: 0.2ex; color:hsl( 30, 0%, 90% ); font-size: 97%; }

.App { display: flex; flex-direction: column; gap: 1em; }

</style>

</head>
<body>
	
<script type="module">

const log = console.log;

import Meh from "../../Meh/meh.js";
import Sound from "../../Meh/sound.js";
const { HTDOM, Range, Leaf, Branch, Location, Page } = Meh;

const Model = {}, SUI = {}, GUI = {};


// Model //

Model.SLF = class
{
	volume = new Leaf.Number( 80 );
	
	ringLevel = new Leaf.Number( 0 );
	
	osc1Level = new Leaf.Number( 0 );
	osc1Freq = new Leaf.Number( 80 );
	
	osc2Level = new Leaf.Number( 0 );
	osc2Freq = new Leaf.Number( 320 );
	
	noiseLevel = new Leaf.Number( 80 );
	noiseFreq = new Leaf.Number( 200 );
	noiseQ = new Leaf.Number( 0 );

	LFO1_Ring_Amp = new Leaf.Number( 0 );
	LFO1_Osc1_Freq = new Leaf.Number( 0 );
	LFO1_Noise_Freq = new Leaf.Number( 0 );
	LFO1_Freq = new Leaf.Number( 0.1 );
	
	noiseGen = new Model.Noise();
}

Model.Osc = class
{
	level = new Leaf.Number( 0 );
	freq = new Leaf.Number( 400 );
};

Model.Noise = class
{
	level = new Leaf.Number( 0 );
	freq = new Leaf.Number( 400 );
};

class SLF extends Branch
{
	vars =
	{
		volume: Number,
		freq: Number,
		noiseLevel: Number,
	};
}


// SUI  sonic user interface //

SUI.VU1 = args =>
{
	return {
		inputs: { },
		doMsg( msg )
		{
			;
		},
		parts:{
			Osc: { type: "Osc" },
			EGGain: { type: "Gain", inputs: "Osc", params: {  } },
		}
	};
};

SUI.Gain = args =>
{
	return {
		input: "gain",
		output: "gain",
		params: { volume: "gain.gain" },
		parts:
		{
			gain: { type: "gain" },
		},
	};
};

SUI.NoiseGen = args =>
{
	const { model } = args;

	const def =
	{
		parts:
		{
			output: { type: "Gain", inputs: "filter" },
			filter: {
				type: "Filter", inputs: "noise",
				attrs: { type: "byQuadFilter" },
				params: { frequency: { charge: model.frequency }, },
			},
			noise: { type: "Noise" },
		}
	};

	return ;
};

SUI.Main = args =>
{
	const { model } = args;

	const cnvA = value => ( value == 0 ? 0 : Math.pow( 2, value / 100 * 8 ) / 256 );
	const cnvB = value => ( value / 100 );

	const def =
	{
		ctrls:
		{
			Master :    { src: model.volume, conv: cnvA },
			Ring_Level : { src: model.ringLevel, conv: cnvB },
			Osc_1_Level_Ctrl : { src: model.osc1Level, conv: cnvB },
			Osc_1_Freq_Ctrl :  { src: model.osc1Freq },
			Osc_2_Level_Ctrl : { src: model.osc2Level, conv: cnvB },
			Osc_2_Freq_Ctrl :  { src: model.osc2Freq },
			LFO_1_Ring_Amp_Ctrl : { src: model.LFO1_Ring_Amp, conv: cnvB },
			LFO_1_Osc1_Freq_Ctrl : { src: model.LFO1_Osc1_Freq },
			LFO_1_Noise_Freq_Ctrl : { src: model.LFO1_Noise_Freq },
			LFO_1_Freq_Ctrl :  { src: model.LFO1_Freq },
			Noise_Level_Ctrl: { src: model.noiseLevel, conv: cnvB },
			Noise_Freq_Ctrl: { src: model.noiseFreq },
			Noise_Q_Ctrl: { src: model.noiseQ },
		},

		parts:
		{
			main: { type: "Gain", inputs: [ "osc1gain", "osc2gain", "noisegain", "ringout", "noiseGen" ], params: { gain: "Master" } },

			ringout: { type: "Gain", inputs: [ "ringamod" ], params: { gain: "Ring_Level" } },
			ringamod: { type: "Gain", inputs: [ "ring" ], params: { gain: [ 1, "LFO_1_Ring_Amp" ] } },
			ring: { type: "Gain", inputs: [ "osc1" ], params: { gain: "osc2" } },

			osc1gain: { type: "Gain", inputs: [ "osc1" ], params: { gain: "Osc_1_Level_Ctrl" } },
			osc1: { type: "Osc", params: { frequency: [ "Osc_1_Freq_Ctrl", "LFO_1_Osc_1_Freq" ] } },
			
			osc2gain: { type: "Gain", inputs: [ "osc2" ], params: { gain: "Osc_2_Level_Ctrl" } },
			osc2: { type: "Osc", params: { frequency: "Osc_2_Freq_Ctrl" } },

			LFO_1_Ring_Amp: { type: "Gain", inputs: [ "LFO_1" ], params: { gain: "LFO_1_Ring_Amp_Ctrl" } },
			LFO_1_Osc_1_Freq: { type: "Gain", inputs: [ "LFO_1" ], params: { gain: "LFO_1_Osc1_Freq_Ctrl" } },
			LFO_1_Noise_Freq: { type: "Gain", inputs: [ "LFO_1" ], params: { gain: "LFO_1_Noise_Freq_Ctrl" } },
			LFO_1: { type: "Osc", params: { frequency: "LFO_1_Freq_Ctrl" } },
			
			noisegain: { type: "Gain", inputs: [ "noiseFilter" ], params: { gain: "Noise_Level_Ctrl" } },
			noiseFilter: { type: "BiquadFilter",
				inputs: [ "noise" ], attrs: { type: "lowpass" },
				params: { frequency: [ "Noise_Freq_Ctrl", "LFO_1_Noise_Freq" ], Q: "Noise_Q_Ctrl" }
			},
			noise: { type: "Noise" },

			noiseGen: { type: SUI.NoiseGen, model: model.noiseGen },
		},
	};
	return def;
};

// GUI //

GUI.Noise = ( { model } ) =>
{
	return {
		type: "div", class: "Ranges",
		parts:[
			{ type: "h2", text: "Noise" },
			{ type: Range, title: "Level", unit: "", model: model.level, min: 0, max: 100, step: 1, },
			{ type: Range, title: "Cutoff", unit: "Hz", model: model.cutoff, min: 0, max: 4000, step: 0.1, },
		]
	};
};

GUI.MG = ( { model, title = "MG" } ) =>
{
	return {
		type: "div", class: "Ranges",
		parts:[
			{ type: "h2", text: title },
			{ type: Range, title: "Freq", unit: "Hz", model: model.freq, min: 0, max: 4000, step: 0.1, },
		]
	};
};

GUI.CtrlA = args =>
{
	const { model } = args;

	return {
		type: "div", class: "Ranges",
		parts:[
			{ type: Range, title: "Volume", unit: "", model: model.volume, min: 0, max: 100, step: 1, },

			{ type: Range, title: "Ring Level", unit: "", model: model.ringLevel, min: 0, max: 100, step: 1, },
			{ type: Range, title: "Osc1 Level", unit: "", model: model.osc1Level, min: 0, max: 100, step: 1, },
			{ type: Range, title: "Osc2 Level", unit: "", model: model.osc2Level, min: 0, max: 100, step: 1, },
			{ type: Range, title: "Noise Level", unit: "", model: model.noiseLevel, min: 0, max: 100, step: 1, },

			{ type: Range, title: "Osc1 Freq", unit: "Hz", model: model.osc1Freq, min: 0, max: 2000, step: 0.1, },
			{ type: Range, title: "Osc2 Freq", unit: "Hz", model: model.osc2Freq, min: 0, max: 2000, step: 0.1, },
			
			{ type: Range, title: "Noise Q",   unit: "", model: model.noiseQ, min: 0, max: 100, step: 0.1, },
			{ type: Range, title: "Noise Freq", unit: "Hz", model: model.noiseFreq, min: 0, max: 8000, step: 1, },

			{ type: Range, title: "LFO1 Ring A", unit: "%", model: model.LFO1_Ring_Amp, min: 0, max: 100, step: 1, },
			{ type: Range, title: "LFO1 Osc1 F", unit: "Hz", model: model.LFO1_Osc1_Freq, min: 0, max: 2000, step: 1, },
			{ type: Range, title: "LFO1 Noise F", unit: "Hz", model: model.LFO1_Noise_Freq, min: 0, max: 2000, step: 1, },
			{ type: Range, title: "LFO1 Freq", unit: "Hz", model: model.LFO1_Freq, min: 0, max: 200, step: 0.01, },
		]
	};
};

GUI.App = args =>
{
	const model = new Model.SLF;
	const page = new Page( { title: "SLF2" } );
	const location = new Location( { page, update( { page } ) { return { title: page.title.value } } } );

	const sound = Sound.create( { type: SUI.Main, model }, args.audioContext );
	const resume = () => sound.resume();

	return {
		type: "div", class: "App",
		acts: { mousedown: resume, keydown: resume, touchstart: resume },
		parts:[
			{ type: "h1", text: page.title },
			{ type: GUI.CtrlA, model },
			{ type: GUI.Noise, model: model.noiseGen },			
		]
	};
};

const main = async () =>
{
	const audioContext = await Sound.getContext( { mehPath: "../../" } );
	HTDOM.create( { type: GUI.App, audioContext }, "body" );
};

window.addEventListener( "load", main );

</script>


</body>
</html>