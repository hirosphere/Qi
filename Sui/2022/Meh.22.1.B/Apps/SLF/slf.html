<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>

* { box-sizing: border-box; margin: 0; padding: 0; }

html
{
	overflow: scroll; 
	height: 100vh;
	background: linear-gradient( 180deg, hsl( 190, 75%, 95% ) 0%, hsl( 215, 60%, 80% ) 100% );
}

body
{
	margin: 0 auto;
	width: 800px; height: 100%; background: hsl( 50, 45%, 100% );
	padding: 1em 2em;
}

.Ranges
{
	gap: 1px;
	display: flex; flex-direction: column;
	justify-content:end;
}

.Range
{
	border-radius: 0.43ex;
	background:hsl( 50, 0%, 42% ); color:hsl( 50, 0%, 90% );
	display: grid;
	padding: 1.3ex 1.3ex;
	grid-template-columns: 12ex 300px 7ex 2ex;
}
.Range .value { margin-left: 1ex; text-align: right; }
.Range .unit { margin-left: 0.2ex; color:hsl( 30, 0%, 90% ); font-size: 97%; }

</style>

</head>
<body>
	
<script type="module">

const log = console.log;

import Meh from "../../Meh/meh.js";
import Sound from "../../Meh/sound.js";
const { HTDOM, Range, Leaf, Branch, Location, Page } = Meh;

const Model = {}, SG = {}, GUI = {};

Model.SLF = class
{
	volume = new Leaf.Number( 80 );
	
	ringLevel = new Leaf.Number( 0 );
	
	osc1Level = new Leaf.Number( 40 );
	osc1Freq = new Leaf.Number( 301 );
	
	osc2Level = new Leaf.Number( 30 );
	osc2Freq = new Leaf.Number( 503 );
	
	noiseLevel = new Leaf.Number( 0 );

	MG1_Freq = new Leaf.Number( 0.2 );
	MG1_Osc1_Freq = new Leaf.Number( 0 );

	noiseGen = new class
	{
		cutOff = new Leaf.Number( 400 );
	};
}

class SLF extends Branch
{
	vars =
	{
		volume: Number,
		freq: Number,
		noiseLevel: Number,
	};
}


SG.VU1 = args =>
{
	return {
		inputs: { },
		doMsg( msg )
		{
			;
		},
		parts:{
			Osc: { type: "Osc" },
			EGGain: { type: "Gain", inputs: "Osc", params: {  } },
		}
	};
};

SG.NoiseGen = args =>
{
	const { model } = args;

	const def =
	{
		output: "Gain",
		consts:
		{
			cutOff: [ model.cutOff, "linear" ],
		},
		parts:
		{
			Gain: { type: "Gain", inputs: "Filter" },
			Filter: { type: "Filter", attrs: { type: "byQuadFilter" }, inputs: "Noise" },
			Noise: { type: "Noise" },
		}
	};

	return ;
};

const SGen = args =>
{
	const { model } = args;

	const vopA = { value: value => value == 0 ? 0 : Math.pow( 2, value / 100 * 8 ) / 256 };
	const vopB = { value: value => value / 100 };

	const def =
	{
		parts:
		{
			main: { type: "Gain", inputs: [ "osc1Gain", "osc2Gain", "noiseGain", "ringGain" ], params: { gain: [ model.volume, vopA ] } },

			ringGain: { type: "Gain", inputs: [ "ring" ], params: { gain: [ model.ringLevel, vopB ] } },
			ring: { type: "Gain", inputs: [ "osc1" ], paramSrcs: { gain: "osc2" } },

			osc1Gain: { type: "Gain", inputs: [ "osc1" ], params: { gain: [ model.osc1Level, vopB ] } },
			osc1: { type: "Osc", params: { frequency: model.osc1Freq } },
			
			osc2Gain: { type: "Gain", inputs: [ "osc2" ], params: { gain: [ model.osc2Level, vopB ] } },
			osc2: { type: "Osc", params: { frequency: model.osc2Freq } },
			
			noiseGain: { type: "Gain", params: { gain: [ model.noiseLevel, vopB ] }, inputs: [ "noise" ] },
			noise: { type: "Noise" },

			NoiseSyn: { type: SG.NoiseGen, model: model.noiseGen },
			
			MG1_Osc1_Freq: { type: "Gain", inputs: [ "MG1" ], params: { gain: [ model.MG1_Osc1_Freq, vopB ] } },
			MG1: { type: "Osc", params: { frequency: model.MG1_Freq } },
		},
	};
	return def;
};

GUI.CtrlA = args =>
{
	const { model } = args;

	return {
		type: "div", class: "Ranges",
		parts:[
			{ type: Range, title: "Volume", unit: "", model: model.volume, min: 0, max: 100, step: 1, },

			{ type: Range, title: "Ring Level", unit: "", model: model.ringLevel, min: 0, max: 100, step: 1, },

			{ type: Range, title: "Osc1 Level", unit: "", model: model.osc1Level, min: 0, max: 100, step: 1, },
			{ type: Range, title: "Osc1 Freq", unit: "Hz", model: model.osc1Freq, min: 0, max: 2000, step: 0.1, },
			
			{ type: Range, title: "Osc2 Level", unit: "", model: model.osc2Level, min: 0, max: 100, step: 1, },
			{ type: Range, title: "Osc2 Freq", unit: "Hz", model: model.osc2Freq, min: 0, max: 2000, step: 0.1, },
			
			{ type: Range, title: "Noise Level", unit: "", model: model.noiseLevel, min: 0, max: 100, step: 1, },
			
			{ type: "h2", text: "MG1" },
			{ type: Range, title: "Osc1 Freq", unit: "", model: model.MG1_Osc1_Freq, min: 0, max: 100, step: 0.1, },
			{ type: Range, title: "Freq", unit: "Hz", model: model.MG1_Freq, min: 0, max: 200, step: 0.02, },
		]
	};
};

GUI.App = args =>
{
	const model = new Model.SLF;
	const page = new Page( { title: "SLF v.2-1-1" } );
	const location = new Location( { page, update( { page } ) { return { title: page.title.value } } } );

	log( args.audioContext, args.d );

	const sound = Sound.create( { type: SGen, model }, args.audioContext );
	const resume = () => sound.resume();

	return {
		type: "div", class: "App",
		acts: { mousedown: resume, keydown: resume, touchstart: resume },
		parts:[
			{ type: "h1", text: "SLF" },
			{ type: GUI.CtrlA, model },
		]
	};
};

const main = async () =>
{
	const audioContext = await Sound.getContext( { mehPath: "../../" } );
	HTDOM.create( { type: GUI.App, audioContext, d: 111 }, "body" );
};

window.addEventListener( "load", main );

</script>


</body>
</html>